---
layout: post
title: 'Setup Boilerplate cho d·ª± √°n NestJS - Ph·∫ßn 3: Request validation v·ªõi class-validator v√† response serialization v·ªõi class-transformer'
date: 2023-05-13 17:27:12 -0000
categories: NestJS
---

ƒê√¢y l√† b√†i vi·∫øt n·∫±m trong Series **NestJS th·ª±c chi·∫øn**, c√°c b·∫°n c√≥ th·ªÉ xem to√†n b·ªô b√†i vi·∫øt ·ªü link: https://viblo.asia/s/nestjs-thuc-chien-MkNLr3kaVgA

---

# ƒê·∫∑t v·∫•n ƒë·ªÅ

Hi·ªán nay vi·ªác x·ª≠ l√Ω d·ªØ li·ªáu user g·ª≠i l√™n API v√† d·ªØ li·ªáu tr·∫£ v·ªÅ t·ª´ API lu√¥n lu√¥n l√† m·ªôt vi·ªác kh√¥ng th·ªÉ thi·∫øu trong qu√° tr√¨nh ph√°t tri·ªÉn d·ª± √°n, h√¥m nay ch√∫ng ta s·∫Ω c√πng t√¨m hi·ªÉu 2 package support r·∫•t t·ªët cho **NestJS** ·ªü lƒ©nh v·ª±c n√†y. ƒê√≥ ch√≠nh l√† **class-validator** v√† **class-transformer**, c·∫£ hai th∆∞ vi·ªán n√†y gi√∫p cho vi·ªác x√°c th·ª±c v√† chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu tr·ªü n√™n d·ªÖ d√†ng h∆°n, ti·∫øt ki·ªám th·ªùi gian v√† gi·∫£m thi·ªÉu c√°c l·ªói li√™n quan ƒë·∫øn d·ªØ li·ªáu.

S·ª≠ d·ª•ng **class-validator** gi√∫p ch√∫ng ta:

- D·ªÖ d√†ng x√°c th·ª±c d·ªØ li·ªáu ƒë·∫ßu v√†o t·ª´ ng∆∞·ªùi d√πng ho·∫∑c c√°c y√™u c·∫ßu API.
- Ti·∫øt ki·ªám th·ªùi gian v√† gi·∫£m thi·ªÉu c√°c l·ªói li√™n quan ƒë·∫øn d·ªØ li·ªáu kh√¥ng h·ª£p l·ªá.
- T·ª± ƒë·ªông x√°c ƒë·ªãnh c√°c l·ªói x·∫£y ra v√† tr·∫£ v·ªÅ th√¥ng b√°o l·ªói c·ª• th·ªÉ cho client.
- T√πy ch·ªânh c√°c quy t·∫Øc x√°c th·ª±c d·ªØ li·ªáu ph√π h·ª£p v·ªõi nhu c·∫ßu c·ªßa d·ª± √°n.

T∆∞∆°ng t·ª± **class-transformer** s·∫Ω mang ƒë·∫øn c√°c c√¥ng d·ª•ng:

- D·ªÖ d√†ng chuy·ªÉn ƒë·ªïi ƒë·ªëi t∆∞·ª£ng l·ªõp (class instance) sang ƒë·ªëi t∆∞·ª£ng ƒë∆°n gi·∫£n (plain object) v√† ng∆∞·ª£c l·∫°i.
- Chuy·ªÉn ƒë·ªïi ƒë·ªãnh d·∫°ng c·ªßa c√°c thu·ªôc t√≠nh (property) trong ƒë·ªëi t∆∞·ª£ng.
- X√≥a ho·∫∑c gi·ªØ l·∫°i c√°c thu·ªôc t√≠nh trong ƒë·ªëi t∆∞·ª£ng.
- T√πy ch·ªânh qu√° tr√¨nh chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu ph√π h·ª£p v·ªõi nhu c·∫ßu c·ªßa d·ª± √°n.

ƒê·ªÉ th·∫•y r√µ h∆°n c√¥ng d·ª•ng c·ªßa ch√∫ng mang l·∫°i, ch√∫ng ta s·∫Ω l·∫ßn l∆∞·ª£t ƒëi ƒë·∫øn n·ªôi dung chi ti·∫øt ·ªü c√°c ph·∫ßn b√™n d∆∞·ªõi. M√¨nh s·∫Ω c·ªë g·∫Øng di·ªÖn t·∫£ chi ti·∫øt v√† ƒë·∫ßy ƒë·ªß nh·∫•t c√≥ th·ªÉ thay v√¨ c√°c n·ªôi dung c∆° b·∫£n ƒë·ªÉ c√°c b·∫°n c√≥ th·ªÉ t·∫≠n d·ª•ng ƒë∆∞·ª£c t·ªëi ƒëa c√°c c√¥ng nƒÉng c·ªßa ch√∫ng.

# Th√¥ng tin package

- "class-validator": "^0.14.0"
- "class-transformer": "^0.5.1"

C√°c b·∫°n c√≥ th·ªÉ t·∫£i v·ªÅ to√†n b·ªô source code c·ªßa ph·∫ßn n√†y [·ªü ƒë√¢y](https://github.com/nntwelve/Boilerplate-NestJS/tree/part-2-mongoose-class-validator-class-transformer)

# 1. Class validator

**class-validator** cung c·∫•p c√°c decorator ƒë·ªÉ th√™m validation cho c√°c thu·ªôc t√≠nh (properties) c·ªßa th√¥ng tin g·ª≠i l√™n t·ª´ request payload. V√≠ d·ª•, n·∫øu ch√∫ng ta mu·ªën ƒë·∫£m b·∫£o r·∫±ng property _email_ ph·∫£i c√≥ ƒë·ªãnh d·∫°ng h·ª£p l·ªá, ch√∫ng ta c√≥ th·ªÉ s·ª≠ d·ª•ng decorator `@IsEmail()` c·ªßa **class-validator**. Th∆∞·ªùng ch√∫ng ta s·∫Ω d√πng validate request (params, query, body payload, ...) ƒë·ªÉ ƒë·∫£m b·∫£o d·ªØ li·ªáu user g·ª≠i l√™n l√† h·ª£p l·ªá.

> V·ªõi params v√† query th√¨ m√¨nh th∆∞·ªùng d√πng v·ªõi Pipe d·∫°ng Parse\*.

## 1.1 C√†i ƒë·∫∑t

Qu√° tr√¨nh validation s·∫Ω s·ª≠ d·ª•ng **ValidationPipe** c·ªßa **NestJS**, v√† n√≥ c·∫ßn s·ª± k·∫øt h·ª£p c·ªßa **class-validator** v√† **class-transfomer** n√™n ch√∫ng ta ph·∫£i c√†i ƒë·∫∑t c·∫£ 2 package n√†y.

`npm i --save class-validator class-transformer`

M√¨nh s·∫Ω s·ª≠ d·ª•ng cho to√†n b·ªô ·ª©ng d·ª•ng n√™n s·∫Ω apply v√†o application level hay **Global Pipe**. B·∫°n n√†o ch∆∞a ƒë·ªçc v·ªÅ **Request Lifecycle** c√≥ th·ªÉ xem l·∫°i b√†i vi·∫øt tr∆∞·ªõc c·ªßa m√¨nh [·ªü ƒë√¢y.](https://viblo.asia/p/cach-request-lifecycle-hoat-dong-trong-nestjs-y3RL1awpLao)

```typescript:main.ts
import { Logger, ValidationPipe } from '@nestjs/common';
...

async function bootstrap() {
	...
	app.useGlobalPipes(new ValidationPipe()) // <== Th√™m v√†o ƒë√¢y
	await app.listen(config_service.get('PORT'), () =>
		logger.log(`Application running on port ${config_service.get('PORT')}`),
	);
}
bootstrap();
```

C√≥ nhi·ªÅu option c√≥ th·ªÉ truy·ªÅn v√†o tham s·ªë c·ªßa ValidationPipe, tuy nhi√™n d∆∞·ªõi ƒë√¢y l√† nh·ªØng option m√¨nh hay s·ª≠ d·ª•ng trong d·ª± √°n:

- `whitelist`: n·∫øu l√† true, s·∫Ω lo·∫°i b·ªè c√°c property kh√¥ng ƒë∆∞·ª£c li·ªát k√™ v·ªõi **class-validator.**
- `forbidNonWhitelisted`: n·∫øu l√† true th√¨ thay v√¨ b·ªè qua b·ªüi `whitelist` s·∫Ω tr·∫£ v·ªÅ l·ªói
- `skipMissingProperties`: n·∫øu property truy·ªÅn v√†o kh√¥ng t·ªìn t·∫°i ho·∫∑c c√≥ gi√° tr·ªã `undefined/null` s·∫Ω b·ªè qua validate cho property ƒë√≥.
- `groups`: m·ªôt s·ªë schema s·∫Ω c√≥ h∆°n 1 lo·∫°i validation, groups gi√∫p ch√∫ng ta ph√¢n lo·∫°i, th·ª±c thi cho t·ª´ng group kh√°c nhau. Option n√†y th∆∞·ªùng ƒë∆∞·ª£c d√πng cho c√°c Pipe b√™n trong **Global Pipe**.

## 1.2 Validate object

Ch√∫ng ta s·∫Ω b·∫Øt ƒë·∫ßu b·∫±ng vi·ªác validate m·ªôt object ƒë∆°n gi·∫£n, ti·∫øn h√†nh th√™m c√°c decorator cho `CreateUserDto` ƒë·ªÉ validate c√°c property:

```typescript:src/modules/users/dto/create-user.dto.ts
import {
	IsEmail,
	IsNotEmpty,
	IsStrongPassword,
	MaxLength,
} from 'class-validator';

export class CreateUserDto {
	@IsNotEmpty() // B·∫Øt bu·ªôc ph·∫£i g·ª≠i l√™n
	@MaxLength(50) // T·ªëi ƒëa 50 k√Ω t·ª±
	first_name: string;

	@IsNotEmpty()
	@MaxLength(50)
	last_name: string;

	@IsNotEmpty()
	@MaxLength(50)
	@IsEmail() // Ph·∫£i l√† ƒë·ªãnh d·∫°ng email
	email: string;

	@IsNotEmpty()
	@MaxLength(50)
	username: string;

	@IsNotEmpty()
	@IsStrongPassword() // Password ph·∫£i ƒë·ªß ƒë·ªô m·∫°nh
	password: string;

    @IsOptional() // Kh√¥ng b·∫Øt bu·ªôc ph·∫£i g·ª≠i l√™n
	address?: CreateAddressDto[];
}
```

> **L∆∞u √Ω**: Tr∆∞·ªõc khi ti·∫øp t·ª•c m√¨nh mu·ªën l∆∞u √Ω c√°c b·∫°n m·ªôt tr∆∞·ªùng h·ª£p m√† khi l√†m vi·ªác v·ªõi NestJS r·∫•t c√≥ th·ªÉ c√°c b·∫°n s·∫Ω m·∫Øc ph·∫£i. ƒê√≥ l√† khi generate code t·ª´ NestCLI s·∫Ω c√≥ d·∫°ng `this.users_repository.create(create_user_dto)` ƒë·ªÉ l∆∞u data t·ª´ `CreateUserDto` v√†o database, vi·ªác n√†y d·∫´n ƒë·∫øn m·ªôt c∆° h·ªôi ƒë·ªÉ ai ƒë√≥ c√≥ th·ªÉ l·ª£i d·ª•ng. V√≠ d·ª• trong **User** schema c√≥ property `point` l√† s·ªë ti·ªÅn user n·∫°p v√†o, n·∫øu ch√∫ng ta d√πng lu√¥n nh∆∞ tr√™n m√† kh√¥ng ch·ªânh s·ª≠a g√¨ ho·∫∑c ch·ªânh s·ª≠a v√† d√πng _spread operator_ `this.users_repository.create({password: hash_password, ...create_user_dto})` th√¨ khi ai ƒë√≥ g·ª≠i k√®m `point: 99999999` s·∫Ω d·∫´n ƒë·∫øn s·ªë point c·ªßa user s·∫Ω th√†nh con s·ªë m√† h·ªç g·ª≠i l√™n (m√¨nh l·∫•y v√≠ d·ª• ƒë·ªÉ minh h·ªça th√¥i ch·ª© th·ª±c t·∫ø ch·∫Øc √≠t ai ƒë·ªÉ logic code t·∫°o user nh∆∞ v·∫≠y üòÖ). C√≥ nhi·ªÅu c√°ch ƒë·ªÉ gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ tr√™n nh∆∞:
>
> - Truy·ªÅn t·ª´ng property h·ª£p l·ªá v√†o function `create` thay v√¨ to√†n b·ªô property trong `CreateUserDto`: c√°ch n√†y ·ªïn nh∆∞ng n·∫øu schema n√†o c√≥ nhi·ªÅu property s·∫Ω l√†m code d√†i d√≤ng.
> - D√πng delete v·ªõi object ƒë·ªÉ delete c√°c property kh√¥ng h·ª£p l·ªá sau ƒë√≥ m·ªõi truy·ªÅn v√†o function `create`: t∆∞∆°ng ·ª©ng v·ªõi n c√°c property c·∫ßn x√≥a s·∫Ω c√≥ n l·ªánh delete ƒë∆∞·ª£c t·∫°o ra.
> - T·∫°o **Factory Pattern** ƒë·ªÉ t·∫°o c√°c property h·ª£p l·ªá: c√°ch n√†y hay v√† l√†m cho code r√µ r√†ng d·ªÖ ƒë·ªçc h∆°n, tuy nhi√™n ph·∫£i m·∫•t th·ªùi gian vi·∫øt th√™m Factory cho t·ª´ng schema.
> - D√πng desctructuring (`const {point, role, ...process_create_user_dto} = create_user_dto`): c√°ch n√†y l√† c·∫£i ti·∫øn c·ªßa delete ·ªü tr√™n, kh√° ·ªïn v√† c√≥ th·ªÉ s·ª≠ d·ª•ng. Nh∆∞ng ƒë√¥i khi n·∫øu kh√¥ng c·∫©n th·∫≠n ƒë·ªÉ s√≥t property c·∫ßn x√≥a th√¨ c≈©ng nh∆∞ kh√¥ng.
> - S·ª≠ d·ª•ng option `whitelist` c·ªßa `ValidationPipe`: ƒë√¢y l√† c√°ch hi·ªán t·∫°i m√¨nh ƒëang d√πng, ch·ªâ c·∫ßn th√™m option ƒë√≥ v√†o, c√°c property n√†o kh√¥ng c√≥ decorator c·ªßa **class-validator** s·∫Ω b·ªã b·ªè qua. ƒê·∫£m b·∫£o ch·ªâ nh·ªØng property trong `CreateUserDto` m·ªõi c√≥ th·ªÉ ƒëi qua `ValidationPipe`. N·∫øu kh√¥ng c√≥ decorator n√†o ph√π h·ª£p cho property ch√∫ng ta c√≥ th·ªÉ d√πng decorator `@Allow`.

- G·ªçi **POST** http://localhost:3333/users ƒë·ªÉ t·∫°o user v√† ki·ªÉm tra k·∫øt qu·∫£
  - C√°c property kh√¥ng h·ª£p l·ªá s·∫Ω tr·∫£ v·ªÅ l·ªói
    ![image.png](https://images.viblo.asia/43ca7fee-1961-4705-bcf8-dacab21e2c5f.png)
  - Th·ª≠ v·ªõi tr∆∞·ªùng h·ª£p d·ªØ li·ªáu h·ª£p l·ªá v√† k√®m v·ªõi `point`. C√≥ th·ªÉ th·∫•y d√π ƒë√£ g·ª≠i l√™n nh∆∞ng s·∫Ω b·ªã `ValidationPipe` lo·∫°i ra
    ![image.png](https://images.viblo.asia/498c7a09-f8dc-40cb-8015-e1192e8daff9.png)

Ti·∫øp theo ch√∫ng ta s·∫Ω ƒë·∫øn v·ªõi `UpdateUserDto`

```typescript:src/modules/users/dto/update-user.dto.ts
import { OmitType, PartialType } from '@nestjs/swagger';
import {
	IsDateString,
	IsEnum,
	IsOptional,
	IsPhoneNumber,
	MaxLength,
} from 'class-validator';
import { GENDER } from '../entities/user.entity';
import { CreateUserDto } from './create-user.dto';

export class UpdateUserDto extends PartialType(
	OmitType(CreateUserDto, ['email', 'password', 'username']),
) {
	@IsOptional()
	@IsPhoneNumber()
	phone_number?: string;

	@IsOptional()
	@IsDateString()
	date_of_birth?: Date;

	@IsOptional()
	@IsEnum(GENDER)
	gender?: string;

	@IsOptional()
	@MaxLength(200)
	headline?: string;
}
```

- V√¨ l√† update ƒëa s·ªë ch·ªâ c·∫ßn c·∫≠p nh·∫≠t m·ªôt s·ªë property n√™n ch√∫ng ta s·∫Ω d√πng `PartialType` chuy·ªÉn c√°c property c·ªßa `CreateUserDto` v·ªÅ tr·∫°ng th√°i _optional_. Tuy nhi√™n ƒë√¥i khi ch√∫ng ta c≈©ng s·∫Ω c·∫ßn lo·∫°i b·ªè m·ªôt s·ªë property t√πy theo logic nghi·ªáp v·ª• nh∆∞ username, email, password ƒë·ªÉ tr√°nh kh√¥ng cho user c·∫≠p nh·∫≠t trong c√°c API nh·∫•t ƒë·ªãnh, do ƒë√≥ m√¨nh d√πng `OmitType` ƒë·ªÉ lo·∫°i b·ªè c√°c property ƒë√≥.
  > C√°c method h·ªØu √≠ch kh√°c nh∆∞: `PickType(DTOObject, ['field_name'] as const)`, `IntersectionType(DTO1, DTO2)`
- **L∆∞u √Ω**: m√¨nh d√πng mapped types t·ª´ `@nestjs/swagger` ch·ª© kh√¥ng d√πng c·ªßa `@nestjs/mapped-types` v√¨ trong series n√†y c√°c b√†i ti·∫øp theo m√¨nh s·∫Ω d√πng Swagger cho API docs v√† theo khuy·∫øn ngh·ªã t·ª´ t√†i li·ªáu c·ªßa NestJS "_Therefore, if you used `@nestjs/mapped-types` (instead of an appropriate one, either `@nestjs/swagger` or `@nestjs/graphql` depending on the type of your app), you may face various, undocumented side-effects._". N√™n ƒë·ªÉ c√≥ th·ªÉ s·ª≠ d·ª•ng c√°c b·∫°n c√†i ƒë·∫∑t package n√†y gi√∫p m√¨nh:
  - C√†i ƒë·∫∑t **@nestjs/swagger**: `npm install --save @nestjs/swagger`
  - Ch√∫ng ta c≈©ng c·∫ßn th√™m v√†o `"plugins": ["@nestjs/swagger"]` trong **nest-cli.json** do kh√°c v·ªõi **@nestjs/mapped-types**, m·∫∑c ƒë·ªãnh `PartialType` c·ªßa **@nestjs/swagger** kh√¥ng l√†m cho c√°c property _optional_ ( xem th√™m [·ªü ƒë√¢y](https://github.com/nestjs/swagger/issues/1043) ).
    ```json:nest-cli.json
    {
       "$schema": "https://json.schemastore.org/nest-cli",
       "collection": "@nestjs/schematics",
       "sourceRoot": "src",
       "compilerOptions": {
           "deleteOutDir": true,
           "plugins": ["@nestjs/swagger"] // <=== Th√™m v√†o ƒë√¢y
       }
    }
    ```
- G·ªçi ƒë·∫øn API **PATCH** http://localhost:3333/users/:id ƒë·ªÉ c·∫≠p nh·∫≠t user v√† ki·ªÉm tra k·∫øt qu·∫£
  - V·ªõi d·ªØ li·ªáu kh√¥ng h·ª£p l·ªá
    ![image.png](https://images.viblo.asia/122ac9d2-20d0-43ca-845b-ccb702a4d75f.png)
  - D·ªØ li·ªáu h·ª£p l·ªá th√¨ c√°c tr∆∞·ªùng ƒë∆∞·ª£c th√™m v√†o s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t. C√≥ th·ªÉ th·∫•y ch√∫ng ta c·∫≠p nh·∫≠t ƒë∆∞·ª£c c·∫£ field `first_name` t·ª´ `CreateUserDto`.
    ![image.png](https://images.viblo.asia/b5bb5678-45c7-4620-952e-89d4bc559141.png)

## 1.3 Validate nested object

Ch√∫ng ta s·∫Ω ƒë·∫øn v·ªõi m·ªôt tr∆∞·ªùng h·ª£p c≈©ng r·∫•t hay g·∫∑p ph·∫£i, payload g·ª≠i ƒëi c√≥ bao g·ªìm _nested object_, khi ƒë√≥ ch√∫ng ta c≈©ng c·∫ßn ƒë·∫£m b·∫£o gi√° tr·ªã g·ª≠i l√™n b√™n trong _nested object_ ph·∫£i ƒë∆∞·ª£c validate. V√≠ d·ª• c·ª• th·ªÉ v·ªõi property `address` b√™n trong user m√† ch√∫ng ta ƒë√£ d√πng ƒë·ªÉ minh h·ªça quan h·ªá one-to-one ·ªü b√†i vi·∫øt tr∆∞·ªõc.

- ƒê·∫ßu ti√™n ch√∫ng ta c·∫≠p nh·∫≠t l·∫°i `CreateAddressDto` ƒë·ªÉ validate cho c√°c property truy·ªÅn v√†o khi c·∫ßn t·∫°o address. C√°ch validation c≈©ng t∆∞∆°ng t·ª± nh∆∞ c√°c module tr√™n, ch·ªâ c√≥ `postal_code` ch√∫ng ta s·∫Ω d√πng method `IsPostalCode` ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh th·ª±c t·∫ø.

```typescript:src/modules/users/dto/create-address.dto.ts
import {
	IsNotEmpty,
	IsNumber,
	IsOptional,
	IsPostalCode,
	MaxLength,
	MinLength,
} from 'class-validator';

export class CreateAddressDto {
	@IsOptional()
	@MinLength(2)
	@MaxLength(120)
	street?: string;

	@IsNotEmpty()
	@MinLength(2)
	@MaxLength(50)
	state: string;

	@IsNotEmpty()
	@MinLength(2)
	@MaxLength(50)
	city: string;

	@IsOptional()
	@IsNumber()
	@IsPostalCode('US')
	postal_code: number;

	@IsNotEmpty()
	@MinLength(2)
	@MaxLength(50)
	country: string;
}
```

- Sau ƒë√≥ th√™m `CreateAddressDto` v√†o `CreateUserDto` v·ªõi property address

```typescript:src/modules/users/dto/create-user.dto.ts
import { CreateAddressDto } from './create-address.dto';
import { Type } from 'class-transformer';
...
export class CreateUserDto {
	...
	@IsOptional()
	@ValidateNested()
	@Type(() => CreateAddressDto)
	address?: CreateAddressDto;
}
```

- Gi·∫£i th√≠ch:
  - `ValidateNested`: ƒë·∫ßu ti√™n ƒë·ªÉ validate nested object ch√∫ng ta c·∫ßn d√πng decorator n√†y, gi√∫p class-validator ƒëi ƒë·∫øn c√°c object b√™n trong.
  - `Type`: `ValidateNested` th√¥i th√¨ v·∫´n ch∆∞a ƒë·ªß, d·ªØ li·ªáu address ƒë∆∞·ª£c g·ª≠i l√™n ban ƒë·∫ßu ·ªü d·∫°ng plain object v√¨ th·∫ø c·∫ßn ƒë∆∞·ª£c transform v·ªÅ instance c·ªßa `CreateAddressDto` ƒë·ªÉ **class-validator** c√≥ th·ªÉ validate. `Type` ƒë∆∞·ª£c import t·ª´ package **class-transformer** m√† ph·∫ßn sau ch√∫ng ta s·∫Ω t√¨m hi·ªÉu.

> Do ƒë√≥ ch·ªâ c·∫ßn thi·∫øu m·ªôt trong 2 decorator tr√™n th√¨ validate cho property ƒë√≥ s·∫Ω b·ªã b·ªè qua.

- Ti·∫øn h√†nh test th·ª≠:
  - Thi·∫øu c√°c property b·∫Øt bu·ªôc s·∫Ω b√°o l·ªói:
    ![image.png](https://images.viblo.asia/1e1ef8b0-fdd2-49f5-809c-822406f90206.png)
  - Kh√¥ng truy·ªÅn address trong l√∫c t·∫°o th√¨ s·∫Ω b·ªè qua validate cho address do ch√∫ng ta d√πng `IsOptional`:
    ![image.png](https://images.viblo.asia/b90edabe-1008-44d7-9fb5-b0c2d755dec7.png)
  - Tr∆∞·ªùng h·ª£p t·∫Øt 1 trong 2 decorator `ValidateNested` ho·∫∑c `Type` th√¨ d√π g·ª≠i address l√™n nh∆∞ng validate cho property c·ªßa address v·∫´n s·∫Ω b·ªã b·ªè qua, v√¨ th·∫ø ch√∫ng ta g·∫∑p validate ·ªü **mongoose**.
    ![](https://images.viblo.asia/b1d0cdb3-8a04-4dc5-ad48-5f75c98f6b90.gif)

## 1.4 Validate Array

Trong tr∆∞·ªùng h·ª£p c√°c b·∫°n mu·ªën validate c√°c item b√™n trong **Array**, ch·∫≥ng h·∫°n c√°c item ph·∫£i thu·ªôc enum n√†o ƒë√≥ . V√≠ d·ª• ch√∫ng ta s·∫Ω th√™m property `interested_languages` cho User schema ƒë·ªÉ bi·ªÉu th·ªã c√°c ngon ng·ªØ m√† user h·ª©ng th√∫. Khi t·∫°o user s·∫Ω g·ª≠i c√°c ng√¥n ng·ªØ ƒë√≥ v·ªõi payload.

- Th√™m property `interested_languages` v√†o **user.entity.ts**

```typescript:src/modules/users/entities/user.entity.ts
export enum LANGUAGES {
	ENGLISH = 'English',
	FRENCH = 'French',
	JAPANESE = 'Japanese',
	KOREAN = 'Korean',
	SPANISH = 'Spanish',
}
...
    @Prop({
		type: [String],
		enum: LANGUAGES,
	})
	interested_languages: LANGUAGES[];
    ...
```

- C·∫≠p nh·∫≠t `CreateUserDto`, ƒë·∫£m b·∫£o n·∫øu user g·ª≠i l√™n `interested_languages` th√¨ m·∫£ng ph·∫£i c√≥ √≠t nh·∫•t 1 ph·∫ßn t·ª≠ v√† c√°c ph·∫ßn t·ª≠ m·∫£ng ph·∫£i thu·ªôc enum `TOPIC`

```typescript:src/modules/users/dto/create-user.dto.ts
import { LANGUAGES } from '../entities/user.entity';
...
export class CreateUserDto {
    @IsOptional() // Kh√¥ng b·∫Øt bu·ªôc
	@IsArray() // N·∫øu c√≥ d·ªØ li·ªáu ph·∫£i l√† d·∫°ng array
	@ArrayMinSize(1) // Array ph·∫£i c√≥ t·ªëi thi·ªÉu 1 ph·∫ßn t·ª≠
	@IsEnum(LANGUAGES, { each: true }) // C√°c ph·∫ßn t·ª≠ c·ªßa array ph·∫£i thu·ªôc enum LANGUAGES
	interested_languages: LANGUAGES[];
    ...
```

- Gi·∫£i th√≠ch:
  - `IsOptional`: v√¨ ch√∫ng ta kh√¥ng b·∫Øt bu·ªôc user ph·∫£i g·ª≠i address n√™n n·∫øu kh√¥ng c√≥ th√¨ s·∫Ω b·ªè qua kh√¥ng c·∫ßn c√°c trigger c√°c decorator b√™n d∆∞·ªõi.
  - `IsArray`: b·∫Øt bu·ªôc data g·ª≠i l√™n ph·∫£i l√† array
  - `ArrayMinSize`: ƒë·ªÉ tr√°nh tr∆∞·ªùng h·ª£p user g·ª≠i m·∫£ng r·ªóng ( trong v√≠ d·ª• c·ªßa ch√∫ng ta kh√¥ng c·∫ßn check c√°i n√†y c≈©ng ƒë∆∞·ª£c, nh∆∞ng trong m·ªôt v√†i tr∆∞·ªùng h·ª£p th·ª±c t·∫ø ph·∫£i ƒë·∫£m b·∫£o m·∫£ng g·ª≠i l√™n kh√¥ng ƒë∆∞·ª£c r·ªóng )
  - `IsEnum( each: true )`: option each gi√∫p validate t·ª´ng ph·∫ßn t·ª≠ trong m·∫£ng

## Validate Array Object

Ch√∫ng ta ƒë·∫øn v·ªõi tr∆∞·ªùng h·ª£p ph·ª©c t·∫°p h∆°n khi item b√™n trong Array l√† Object v√† b·∫Øt bu·ªôc c·∫ßn ph·∫£i validate. V√≠ d·ª• c√≥ y√™u c·∫ßu t·ª´ ph√≠a kh√°ch h√†ng c·∫ßn thay ƒë·ªïi cho ph√©p user l∆∞u nhi·ªÅu address, khi n√†y ch√∫ng ta s·∫Ω ch·ªânh s·ª≠a l·∫°i:

- Ch·ªânh s·ª≠a l·∫°i property address trong User Schema th√†nh Array

```typescript:src/modules/users/entities/user.entity.ts
...
    @Prop({
		type: [
			{
				type: AddressSchema,
			},
		],
	})
	address: Address[];
    ...
```

- C·∫≠p nh·∫≠t `CreateUserDto`, ƒë·∫£m b·∫£o n·∫øu user g·ª≠i l√™n address th√¨ m·∫£ng ph·∫£i c√≥ √≠t nh·∫•t 1 ph·∫ßn t·ª≠ v√† c√°c ph·∫ßn t·ª≠ m·∫£ng ph·∫£i thu·ªôc validate v·ªõi `CreateAddressDto`

```typescript:
...
export class CreateUserDto {
    ...
    @IsOptional()
	@IsArray()
	@ArrayMinSize(1)
	@ValidateNested({ each: true })
	@Type(() => CreateAddressDto)
	address?: CreateAddressDto[];
    ...
```

- Gi·∫£i th√≠ch: ch√∫ng ta s·∫Ω d√πng k·∫øt h·ª£p gi·ªØa validate nested object v√† validate array ƒë·ªÉ gi·∫£i quy·∫øt tr∆∞·ªùng h·ª£p n√†y. T·∫•t nhi√™n c√°c b·∫°n kh√¥ng ƒë∆∞·ª£c b·ªè s√≥t `ValidateNested` ho·∫∑c `Type` nh∆∞ ƒë√£ n√≥i ·ªü tr√™n.

# 2. Serialization v·ªõi class-transformer

Trong NestJS, **class-transformer** th∆∞·ªùng ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ th·ª±c hi·ªán vi·ªác chuy·ªÉn ƒë·ªïi ƒë·ªëi t∆∞·ª£ng l·ªõp (class instances) sang ƒë·ªëi t∆∞·ª£ng ƒë∆°n gi·∫£n (plain objects) v√† ng∆∞·ª£c l·∫°i, gi√∫p thao t√°c v·ªõi d·ªØ li·ªáu tr·ªü n√™n d·ªÖ d√†ng c≈©ng nh∆∞ ƒëi·ªÅu ch·ªânh l·∫°i reponse ph√π h·ª£p tr∆∞·ªõc khi tr·∫£ v·ªÅ cho ng∆∞·ªùi d√πng. C·ª• th·ªÉ c√°c

## 2.1 C√†i ƒë·∫∑t

Ch√∫ng ta ƒë√£ c√†i ƒë·∫∑t class-transformer ·ªü tr√™n c√πng v·ªõi class-validator.

## 2.2 C√°ch s·ª≠ d·ª•ng

V√≠ d·ª• ·ªü ƒë√¢y m√¨nh s·∫Ω th√™m property `stripe_customer_id` ƒë·ªÉ sau n√†y d√πng cho b√†i vi·∫øt thanh to√°n v·ªõi _Stripe_, sau ƒë√≥ s·ª≠ d·ª•ng decorator `@Exclude` lo·∫°i b·ªè property ƒë√≥ kh·ªèi c√°c response.

```typescript:src/modules/users/entities/user.entity.ts
import { Exclude } from 'class-transformer';
...
    @Prop({
		default: 'cus_mock_id',
	})
	@Exclude()
	stripe_customer_id: string;
```

T·∫°o l·∫°i user xem property `stripe_customer_id` c√≥ b·ªã lo·∫°i b·ªè ch∆∞a.
![](https://images.viblo.asia/eccbcc7b-a1cb-47af-9457-5c650a77fea1.png)

- C√≥ th·ªÉ th·∫•y v·∫´n ch∆∞a nh∆∞ ch√∫ng ta mong ƒë·ª£i, ch√∫ng ta c·∫ßn th√™m m·ªôt b∆∞·ªõc l√† d√πng **Interceptors** n·ªØa m·ªõi c√≥ th·ªÉ apply logic tr√™n. ·ªû ƒë√¢y m√¨nh s·∫Ω apply cho to√†n b·ªô c√°c API trong user module n√™n d√πng `ClassSerializerInterceptor` cho **Controller Interceptor**.

```typescript:src/modules/users/users.controller.ts
import { UseInterceptors, ClassSerializerInterceptor } from '@nestjs/common';
@UseInterceptors(ClassSerializerInterceptor)
export class UsersController {
...
```

- Th·ª≠ g·ªçi API get l·∫°i user ch√∫ng ta v·ª´a t·∫°o
  ![](https://images.viblo.asia/d5f5b05e-3141-4ccd-8a60-a27a3d18fef5.png)
- L·∫ßn n√†y kh√¥ng nh·ªØng property `stripe_customer_id` kh√¥ng m·∫•t m√† c√≤n k√©o theo s·ª± xu·∫•t hi·ªán c·ªßa h√†ng lo·∫°t property kh√°c c·ªßa MongoDB. Nguy√™n nh√¢n kh√¥ng ph·∫£i do ch√∫ng ta sai, m√† l√† do response c·ªßa MongoDB kh√¥ng t∆∞∆°ng th√≠ch v·ªõi c√°ch m√† **class-transformer** response (n·∫øu c√°c b·∫°n d√πng c√°c h·ªá qu·∫£n tr·ªã c∆° s·ªü d·ªØ li·ªáu kh√°c th√¨ s·∫Ω kh√¥ng b·ªã v·∫•n ƒë·ªÅ n√†y).
- ƒê·ªÉ gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ, ch√∫ng ta c·∫ßn custom l·∫°i `ClassSerializerInterceptor` ƒë·ªÉ ƒë·ªìng nh·∫•t c√°ch response gi·ªØa 2 package tr√™n.

```typescript:src/interceptors/mongoose-class-serializer.interceptor.ts
import {
	ClassSerializerInterceptor,
	PlainLiteralObject,
	Type,
} from '@nestjs/common';
import { ClassTransformOptions, plainToClass } from 'class-transformer';
import { Document } from 'mongoose';

function MongooseClassSerializerInterceptor(
	classToIntercept: Type,
): typeof ClassSerializerInterceptor {
	return class Interceptor extends ClassSerializerInterceptor {
		private changePlainObjectToClass(document: PlainLiteralObject) {
			if (!(document instanceof Document)) {
				return document;
			}
			return plainToClass(classToIntercept, document.toJSON());
		}

		private prepareResponse(
			response:
				| PlainLiteralObject
				| PlainLiteralObject[]
				| { items: PlainLiteralObject[]; count: number },
		) {
			if (!Array.isArray(response) && response?.items) {
				const items = this.prepareResponse(response.items);
				return {
					count: response.count,
					items,
				};
			}

			if (Array.isArray(response)) {
				return response.map(this.changePlainObjectToClass);
			}

			return this.changePlainObjectToClass(response);
		}

		serialize(
			response: PlainLiteralObject | PlainLiteralObject[],
			options: ClassTransformOptions,
		) {
			return super.serialize(this.prepareResponse(response), options);
		}
	};
}

export default MongooseClassSerializerInterceptor;
```

- Gi·∫£i th√≠ch:
  - Ch√∫ng ta s·∫Ω t·∫°o ra 1 **HoC** v·ªõi m·ª•c ƒë√≠ch nh·∫≠n v√†o schema.
  - Sau ƒë√≥ ch√∫ng ta return v·ªÅ custom class k·∫ø th·ª´a `ClassSerializerInterceptor` ƒë·ªÉ overide l·∫°i method `serialize` c·ªßa n√≥.
  - C√°c b·∫°n ch√∫ √Ω ƒë·ªÉ method `prepareResponse`, ƒë√¢y l√† n∆°i ch√∫ng ta ki·ªÉm tra tr∆∞·ªõc khi serialize response.
    - ·ªû d√≤ng `if (!Array.isArray(response) && response?.items)` m√¨nh d√πng ƒë·ªÉ x·ª≠ l√Ω cho method `findAll`. Ch√∫ng ta g·ªçi ƒë·ªá quy b√™n trong d√πng cho tr∆∞·ªùng h·ª£p schema c√≥ nested object b√™n trong (v√≠ d·ª• user b√™n trong flash-card).
    - D√≤ng `if (Array.isArray(response))` d√πng ƒë·ªÉ tr·∫£ v·ªÅ cho tr∆∞·ªùng h·ª£p response l√† array (v√≠ d·ª• address b√™n trong user ho·∫∑c v·ªõi `findAll` sau khi ƒë·ªá quy ·ªü if ƒë·∫ßu ti√™n s·∫Ω g·∫∑p d√≤ng if n√†y ƒë·ªÉ x·ª≠ l√≠ ti·∫øp).
  - V·ªõi method `changePlainObjectToClass` s·∫Ω l√† n∆°i ch√≠nh ch√∫ng ta gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ kh√¥ng ƒë·ªìng nh·∫•t gi·ªØa mongoose v√† class-transfomer. `if (!(document instanceof Document))` n·∫øu response kh√¥ng ph·∫£i l√† Document c·ªßa mongoose th√¨ ch√∫ng ta s·∫Ω tr·∫£ v·ªÅ. Ng∆∞·ª£c l·∫°i n·∫øu l√† Document ch√∫ng ta c·∫ßn chuy·ªÉn n√≥ v·ªÅ JSON sau ƒë√≥ transfer sang Class c·ªßa Schema ƒë√≥.

```typescript:src/modules/users/users.controller.ts
import { UseInterceptors } from '@nestjs/common';
import { User } from './entities/user.entity';
import { MongooseClassSerializerInterceptor } from 'src/interceptors/mongoose-class-serializer.interceptor';
@UseInterceptors(MongooseClassSerializerInterceptor(User)) // L∆∞u √Ω kh√¥ng ƒë∆∞·ª£c qu√™n User schema
export class UsersController {
...
```

- Th·ª≠ l·∫°i xem k·∫øt qu·∫£ ƒë√£ ho·∫°t ƒë·ªông ch∆∞a

![](https://images.viblo.asia/c234f58b-02d8-4e24-afab-9bc6c7123094.png)

K·∫øt qu·∫£ ƒë√£ th√†nh c√¥ng lo·∫°i b·ªè c√°c property m√¨nh mu·ªën kh·ªèi response. C√≥ nhi·ªÅu option kh√°c ƒë·ªÉ c√°c b·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng nh∆∞:

- ƒê·ªëi v·ªõi c√°c schema c·∫ßn lo·∫°i b·ªè nhi·ªÅu property th√¨ ch√∫ng ta c√≥ th·ªÉ d√πng @Exclude sau ƒë√≥ d√πng `@Expose` ƒë·ªÉ hi·ªÉn th·ªã c√°c property c·∫ßn thi·∫øt

```typescript:src/modules/user-roles/entities/user-role.entity.ts
import { Exclude, Expose } from 'class-transformer';
...
@Exclude()
export class UserRole extends BaseEntity {
	@Prop({
		unique: true,
		default: USER_ROLE.USER,
		enum: USER_ROLE,
		required: true,
	})
	@Expose()
	name: USER_ROLE;

	@Prop()
	description: string;
}
...
```

- Trong tr∆∞·ªùng h·ª£p c√°c b·∫°n thi·∫øt k·∫ø c√°c property private b·∫Øt ƒë·∫ßu v·ªõi prefix "_" th√¨ c√≥ th·ªÉ d√πng option nh∆∞ sau `excludePrefixes: ["_"]` ƒë·ªÉ m·∫∑c ƒë·ªãnh lo·∫°i b·ªè c√°c property b·∫Øt ƒë·∫ßu b·∫±ng "\_".

```typescript:src/interceptors/mongoose-class-serializer.interceptor.ts
...
export function MongooseClassSerializerInterceptor(
	classToIntercept: Type,
): typeof ClassSerializerInterceptor {
    return class Interceptor extends ClassSerializerInterceptor {
        private changePlainObjectToClass(document: PlainLiteralObject) {
            if (!(document instanceof Document)) { return document }
            return plainToClass(classToIntercept, document.toJSON(), { excludePrefixes: ['_'] });
        }
        ...
```

## 2.3 C√°c case th√¥ng d·ª•ng

### planToClass

Ph∆∞∆°ng th·ª©c n√†y chuy·ªÉn ƒë·ªïi m·ªôt javascript object th√†nh instance c·ªßa class c·ª• th·ªÉ. ·ªû `changePlainObjectToClass` ch√∫ng ta ƒë√£ chuy·ªÉn Document v·ªÅ JSON sau ƒë√≥ m·ªõi d√πng **planToClass** ƒë·ªÉ chuy·ªÉn l·∫°i instance c·ªßa input class.

### Transform

ƒê∆∞·ª£c d√πng cho tr∆∞·ªùng h·ª£p khi g·ªçi API users c√≥ bao g·ªìm c·∫£ object c·ªßa role, nh∆∞ v·∫≠y th√¨ ƒë√¥i khi d√†i d√≤ng v√† kh√¥ng hay, n√™n ch√∫ng ta c√≥ th·ªÉ ch·ªânh l·∫°i cho ng·∫Øn g·ªçn h∆°n nh∆∞ b√™n d∆∞·ªõi.

```typescript:src/modules/users/entities/user.entity.ts
import { Transform, Type } from 'class-transformer';
...
export class User extends BaseEntity {

...
    @Prop({
		type: mongoose.Schema.Types.ObjectId,
		ref: UserRole.name,
	})
	@Type(() => UserRole)
	@Transform((value) => value.obj.role?.name, { toClassOnly: true })
	role: UserRole;
```

K·∫øt qu·∫£ sau khi transform, property `role` chuy·ªÉn t·ª´ `role: { name: "User" }` sang `role: "User"` nh∆∞ b√™n d∆∞·ªõi
![image.png](https://images.viblo.asia/a5575889-3059-4b24-9df2-341b4892077f.png)

### Working with nested objects

ƒê√¢y c≈©ng l√† tr∆∞·ªùng h·ª£p ƒë∆∞·ª£c s·ª≠ d·ª•ng th√¥ng d·ª•ng m√† c√°c b·∫°n th∆∞·ªùng hay b·∫Øt g·∫∑p. V√≠ d·ª•, gi·∫£ s·ª≠ v·ªõi property address c·ªßa user, ch√∫ng ta mu·ªën ·∫©n ƒëi property `postal_code` ƒë·ªëi v·ªõi request g·ªçi ƒë·∫øn c√°c API c·ªßa user module. N·∫øu b√¨nh th∆∞·ªùng ch√∫ng ta ch·ªâ d√πng `@Exclude` th√¥i th√¨ v·∫´n ch∆∞a ƒë·ªß.

```typescript:src/modules/users/entities/address.entity.ts
import { Exclude } from 'class-transformer';
...
export class Address extends BaseEntity {
    ...
	@Prop({ required: false, minlength: 2, maxlength: 50 })
	@Exclude()
	postal_code?: number;
...
```

Khi t·∫°o, c·∫≠p nh·∫≠t ho·∫∑c get user th√¨ property `postal_code` v·∫´n ƒë∆∞·ª£c tr·∫£ v·ªÅ trong `address`.

![image.png](https://images.viblo.asia/58a930d2-3040-4ddd-93fc-296334525889.png)

Nguy√™n nh√¢n l√† do _"Since Typescript does not have good reflection abilities yet, we should implicitly specify what type of object each property contain"_. ƒê·ªÉ gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ n√†y ch√∫ng ta c·∫ßn th√™m v√†o decorator `@Type` cho property address trong user schema.

```typescript:src/modules/users/entities/user.entity.ts
import { Exclude, Expose, Type } from 'class-transformer';
...
export class User extends BaseEntity {
    @Prop({
		type: [
			{ type: AddressSchema },
		],
	})
	@Type(() => Address)
	address: Address[];
    ...
```

Th·ª≠ l·∫°i v·ªõi nh·ªØng g√¨ v·ª´a ch·ªânh s·ª≠a, c√≥ th·ªÉ th·∫•y property `postal_code` ƒë√£ ƒë∆∞·ª£c ·∫©n ƒëi.
![image.png](https://images.viblo.asia/8ec9d9af-59f6-4a12-ba07-672a0adc397d.png)

### Exposing properties with different names

V√≠ d·ª• ch√∫ng ta expose ra `getter fullName` ƒë·ªÉ truy xu·∫•t t√™n ƒë·∫ßy ƒë·ªß c·ªßa user, sau ƒë√≥ d√πng option `name` ƒë·ªÉ ƒë·ªïi l·∫°i t√™n theo √Ω ch√∫ng ta mu·ªën

```typescript:src/modules/users/entities/user.entity.ts
...
export class User extends BaseEntity {
    ...
    @Expose({ name: 'full_name' })
	get fullName(): string {
		return `${this.first_name} ${this.last_name}`;
	}
    ...
```

K·∫øt qu·∫£
![image.png](https://images.viblo.asia/581f283d-5213-47de-a4d2-094ac6d8165d.png)

**L∆∞u √Ω:** n·∫øu d√πng v·ªõi c√°c property th√¨ ph·∫£i s·ª≠ d·ª•ng v·ªõi option `toPlainOnly: true`, n·∫øu kh√¥ng property s·∫Ω bi·∫øn m·∫•t thay v√¨ ƒë∆∞·ª£c ƒë·ªïi t√™n.

- V√≠ d·ª• m√¨nh s·∫Ω rename property email sang mail nh∆∞ b√™n d∆∞·ªõi, property email s·∫Ω b·ªã m·∫•t trong response.

```typescript:src/modules/users/entities/user.entity.ts
import { Exclude, Expose, Type } from 'class-transformer';
...
export class User extends BaseEntity {
    @Prop({
		required: true,
		unique: true,
		match: /^\w+([.-]?\w+)*@\w+([.-]?\w+)*(\.\w{2,3})+$/,
	})
	@Expose({ name: 'mail'})
	email: string;
    ...
```

![image.png](https://images.viblo.asia/27ce30c7-6aa3-45d6-addf-6f7f2ed0f672.png)

- Th√™m v√†o option `toPlainOnly: true` ƒë·ªÉ gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ tr√™n

```typescript:src/modules/users/entities/user.entity.ts
import { Exclude, Expose, Type } from 'class-transformer';
...
export class User extends BaseEntity {
    @Prop({
		required: true,
		unique: true,
		match: /^\w+([.-]?\w+)*@\w+([.-]?\w+)*(\.\w{2,3})+$/,
	})
	@Expose({ name: 'mail', toPlainOnly: true })
	email: string;
    ...
```

![image.png](https://images.viblo.asia/8eabf6c2-66e2-43ec-8671-8ea948bcf96a.png)

> Tuy nhi√™n trong tr∆∞·ªùng h·ª£p n·∫øu d√πng `@Exclude` ƒë·ªÉ lo·∫°i b·ªè to√†n b·ªô property sau ƒë√≥ `@Expose` c√°c property c·∫ßn hi·ªÉn th·ªã th√¨ kh√¥ng ƒë∆∞·ª£c d√πng option name, s·∫Ω g·∫∑p l·ªói m·∫•t property nh∆∞ tr√™n. M√¨nh ƒëang t√¨m nguy√™n nh√¢n, c√°c b·∫°n n√†o hi·ªÉu r√µ c√≥ th·ªÉ comment gi·∫£i th√≠ch gi√∫p m√¨nh v√† m·ªçi ng∆∞·ªùi nha. V√≠ d·ª• nh∆∞ b√™n d∆∞·ªõi s·∫Ω l√†m m·∫•t property name m·∫∑c d√π ch√∫ng ta s·ª≠ d·ª•ng `toPlainOnly`
>
> ```typescript:src/modules/user-roles/entities/user-role.entity.ts
> ...
> @Exclude()
> export class UserRole extends BaseEntity {
> 	@Prop({...})
> 	@Expose({ name: 'role', toPlainOnly: true })
> 	name: string;
> ...
> ```

### Skipping specific properties

C√≥ 2 c√°ch nh∆∞ ch√∫ng ta ƒë√£ v√≠ d·ª• ·ªü tr√™n

- D√πng `@Exclude` cho 1 property c·ª• th·ªÉ ƒë·ªÉ lo·∫°i b·ªè property ƒë√≥.
- D√πng `@Exclude` cho to√†n schema ƒë·ªÉ lo·∫°i b·ªè t·∫•t c·∫£ c√°c property, sau ƒë√≥ `@Expose` c√°c property c√≤n l·∫°i ƒë·ªÉ hi·ªÉn th·ªã ch√∫ng ra.

### Skipping some prefixed properties

Ch√∫ng ta ƒë√£ s·ª≠ d·ª•ng `excludePrefixes` trong `MongooseClassSerializerInterceptor` ƒë·ªÉ lo·∫°i b·ªè c√°c property b·∫Øt ƒë·∫ßu b·∫±ng "\_", c√°c b·∫°n c√≥ th·ªÉ th√™m v√†o c√°c prefix kh√°c trong array value c·ªßa `excludePrefixes` ƒë·ªÉ lo·∫°i b·ªè h√†ng lo·∫°t c√°c property m√¨nh mu·ªën.

Ho·∫∑c c√°c b·∫°n c√≥ th·ªÉ d√πng decorator `@SerializeOptions` v·ªõi option `excludePrefixes` cho c√°c API c·ª• th·ªÉ ƒë·ªÉ lo·∫°i b·ªè c√°c property m√¨nh mu·ªën d·ª±a v√†o prefix. V√≠ d·ª• m√¨nh s·∫Ω lo·∫°i b·ªè property b·∫Øt ƒë·∫ßu b·∫±ng `first` v√† `last` trong API **findAllUsers**.

```typescript:src/modules/users/users.controller.ts
import { SerializeOptions } from '@nestjs/common';
...
export class UsersController {
    ...
    @SerializeOptions({
		excludePrefixes: ['first', 'last'],
	})
	@Get()
	findAll() { return this.users_service.findAll(); }
    ...
```

- G·ªçi http://localhost:3333/users, c√°c property ƒë√£ m·∫•t theo d·ª± ƒë·ªãnh c·ªßa ch√∫ng ta.
  ![image.png](https://images.viblo.asia/e6e5c2c5-2bb4-4e7a-8b16-efc49429becb.png)
- Tuy nhi√™n ·ªü ƒë√¢y c√≥ m·ªôt v·∫•n ƒë·ªÅ ph√°t sinh, property `_id` ƒë√£ bi·∫øn m·∫•t. Ch√∫ng ta c·∫ßn expose ra id ƒë·ªÉ d√πng cho c√°c m·ª•c ƒë√≠ch kh√°c, ch·ªânh s·ª≠a l·∫°i `BaseEntity` ƒë·ªÉ gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ tr√™n.

  ```typescript:src/modules/shared/base/base.entity.ts
  import { Prop } from '@nestjs/mongoose';
  import { Expose, Transform } from 'class-transformer';

  export class BaseEntity {
      @Expose()
      @Transform((value) => value.obj?._id?.toString(), { toClassOnly: true })
      id?: string;
      ...
  }
  ```

- Th·ª≠ l·∫°i xem response ƒë√£ c√≥ `id` nh∆∞ ch√∫ng ta mong mu·ªën hay ch∆∞a
  ![image.png](https://images.viblo.asia/c6d61618-97ab-4c7b-a658-09e9117e3011.png)

# K·∫øt lu·∫≠n

Trong b√†i vi·∫øt n√†y ch√∫ng ta ƒë√£ th·ª±c hi·ªán vi·ªác c√†i ƒë·∫∑t v√† c·∫•u h√¨nh th∆∞ vi·ªán **class-validator** v√† **class-transformer** trong ·ª©ng d·ª•ng **NestJS**. Ti·∫øp theo, ch√∫ng ta ƒë√£ t·∫°o m·ªôt DTO (Data Transfer Object) ƒë·ªÉ **validate** c√°c tr∆∞·ªùng c·ªßa request v√† k·∫øt h·ª£p v·ªõi class-validator ƒë·ªÉ th·ª±c hi·ªán validation. Sau ƒë√≥, ch√∫ng ta ƒë√£ s·ª≠ d·ª•ng class-transformer ƒë·ªÉ **serialize** ƒë·ªëi t∆∞·ª£ng response tr·∫£ v·ªÅ t·ª´ controller, gi√∫p ch√∫ng ta c√≥ th·ªÉ tu·ª≥ ch·ªânh ƒë·ªãnh d·∫°ng c·ªßa response d·ª±a tr√™n c√°c quy t·∫Øc chuy·ªÉn ƒë·ªïi ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a s·∫µn. Cu·ªëi c√πng, ch√∫ng ta ƒë√£ t√¨m hi·ªÉu v·ªÅ c√°ch s·ª≠ d·ª•ng **ValidationPipe** ƒë·ªÉ t·ª± ƒë·ªông x√°c th·ª±c c√°c request v√† serialize c√°c response tr·∫£ v·ªÅ. V·ªõi ValidationPipe, ch√∫ng ta c√≥ th·ªÉ tu·ª≥ ch·ªânh c√°c t√πy ch·ªçn v√† quy t·∫Øc validation theo √Ω mu·ªën.

Tuy nhi√™n, vi·ªác b·∫£o m·∫≠t ·ª©ng d·ª•ng kh√¥ng ch·ªâ d·ª´ng l·∫°i ·ªü vi·ªác validate request v√† serialize response. Trong b√†i vi·∫øt ti·∫øp theo, ch√∫ng ta s·∫Ω t√¨m hi·ªÉu v·ªÅ c√°ch th·ª±c hi·ªán x√°c th·ª±c v·ªõi JWT s·ª≠ d·ª•ng thu·∫≠t to√°n b·∫•t ƒë·ªëi x·ª©ng d√πng package **crypto** c·ªßa NodeJS m·ªõi. ƒêi·ªÅu n√†y gi√∫p ch√∫ng ta ƒë·∫£m b·∫£o t√≠nh an to√†n cho c√°c request ƒë∆∞·ª£c g·ª≠i ƒë·∫øn t·ª´ client v√† tƒÉng c∆∞·ªùng t√≠nh b·∫£o m·∫≠t cho ·ª©ng d·ª•ng c·ªßa m√¨nh.

B√†i vi·∫øt m·ªõi n√†y s·∫Ω gi√∫p b·∫°n hi·ªÉu r√µ h∆°n v·ªÅ JWT, c√°ch s·ª≠ d·ª•ng thu·∫≠t to√°n b·∫•t ƒë·ªëi x·ª©ng ƒë·ªÉ m√£ h√≥a v√† gi·∫£i m√£ token, c√°ch √°p d·ª•ng JWT trong NestJS ƒë·ªÉ x√°c th·ª±c v√† b·∫£o m·∫≠t c√°c request g·ª≠i ƒë·∫øn t·ª´ client. H√£y ti·∫øp t·ª•c theo d√µi series c·ªßa ch√∫ng ta ƒë·ªÉ t√¨m hi·ªÉu th√™m v·ªÅ ch·ªß ƒë·ªÅ n√†y.

# T√†i li·ªáu tham kh·∫£o

- Documentation: Nestjs - a progressive node.js framework (no date) NestJS. Available at: https://docs.nestjs.com/techniques/validation (Accessed: 12 May 2023).
- Typestack (no date) Typestack/class-validator: Decorator-based property validation for classes., GitHub. Available at: https://github.com/typestack/class-validator (Accessed: 12 May 2023).
- Typestack (no date a) Typestack/class-transformer: Decorator-based transformation, serialization, and deserialization between objects and classes., GitHub. Available at: https://github.com/typestack/class-transformer (Accessed: 12 May 2023).
