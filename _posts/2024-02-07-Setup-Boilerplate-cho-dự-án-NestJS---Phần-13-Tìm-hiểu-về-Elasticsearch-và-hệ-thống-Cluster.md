ƒê√¢y l√† b√†i vi·∫øt n·∫±m trong Series NestJS th·ª±c chi·∫øn, c√°c b·∫°n c√≥ th·ªÉ xem to√†n b·ªô b√†i vi·∫øt ·ªü link: https://viblo.asia/s/nestjs-thuc-chien-MkNLr3kaVgA
![](https://images.viblo.asia/2420e413-1d6d-4e38-b275-f329bf08f327.png)

**üå∏üåºüêç Xin ch√†o m·ªçi ng∆∞·ªùi ü´°, l√¢u r·ªìi m·ªõi c√≥ th·ªùi gian ng·ªìi l·∫°i chia s·∫ª v√† th·∫£o lu·∫≠n v·ªõi m·ªçi ng∆∞·ªùi, nƒÉm v·ª´a r·ªìi m√¨nh b·∫≠n qu√° ü´•. Ch√∫c m·ªçi ng∆∞·ªùi nƒÉm m·ªõi vui v·∫ª üêçüåºüå∏**
# ƒê·∫∑t v·∫•n ƒë·ªÅ üìú
Ch√∫ng ta c√πng ƒëi th·∫≥ng v√†o v·∫•n ƒë·ªÅ n·ªëi ti·∫øp v·ªõi b√†i vi·∫øt tr∆∞·ªõc b·∫±ng c√¢u h·ªèi sau:

**Elasticsearch l√† g√¨? T·∫°i sao ph·∫£i d√πng Elasticsearch trong khi c√°c database kh√°c ƒë√£ c√≥ h·ªó tr·ª£ Full Text Search v√† chi ph√≠ ƒë·ªÉ kh·ªüi ch·∫°y Elasticsearch c≈©ng ti√™u t·ªën kh√¥ng √≠t t√†i nguy√™n?**

ƒê√≥ m·ªôt trong nh∆∞ng c√¢u h·ªèi m√† ban ƒë·∫ßu m√¨nh nghƒ© t·ªõi l√∫c x∆∞a khi nghe s·∫øp y√™u c·∫ßu t√≠ch h·ª£p Elasticsearch v√†o h·ªá th·ªëng. Ch·∫Øc c√°c b·∫°n c≈©ng c√≤n nh·ªõ ·ªü b√†i vi·∫øt tr∆∞·ªõc v·ªÅ Full Text Search: [Setup Boilerplate cho d·ª± √°n NestJS - Ph·∫ßn 12: Full Text Search v·ªõi MongoDB üìñ](https://viblo.asia/p/setup-boilerplate-cho-du-an-nestjs-phan-12-full-text-search-voi-mongodb-bXP4WzjKV7G) ch√∫ng ta ƒë√£ bi·∫øt ƒë∆∞·ª£c v·ªõi c√°c database hi·ªán ƒë·∫°i ng√†y nay th√¨ vi·ªác t√¨m ki·∫øm hi·ªáu qu·∫£ l√† ƒëi·ªÅu ch√∫ng ta c√≥ th·ªÉ ƒë·∫°t ƒë∆∞·ª£c.

> C√¢u tr·∫£ l·ªùi ng·∫Øn g·ªçn nh·∫•t l√†: **nhanh, d·ªÖ t√≠ch h·ª£p v√† s·ª≠ d·ª•ng, d·ªÖ scale theo chi·ªÅu ngang v√† kh·∫£ nƒÉng ch·ªãu l·ªói t·ªët üí™**.

Sau qu√° tr√¨nh nghi√™n c·ª©u v√† l√†m vi·ªác m√¨nh r√∫t ra m·ªôt s·ªë l·ª£i √≠ch sau ‚ùáÔ∏è:
   - **1Ô∏è‚É£ Elasticsearch ƒë∆°n gi·∫£n l√† 1 search engine v√† c√≥ h·ªó tr·ª£ RESTful API**: gi√∫p ch√∫ng ta d·ªÖ d√†ng t√≠ch h·ª£p v√†o source code v√† linh ho·∫°t h∆°n trong vi·ªác ki·ªÉm so√°t d·ªØ li·ªáu thay v√¨ ƒë·ªÉ to√†n b·ªô cho database. 
   - **2Ô∏è‚É£ Elasticsearch c√≥ h·ªó tr·ª£ ki·∫øn tr√∫c multiple node**: t·ª± c√¢n b·∫±ng multi-node clusters gi√∫p kh·∫£ nƒÉng scale tr·ªü n√™n d·ªÖ d√†ng. M·ªói khi ch√∫ng ta th√™m 1 Node m·ªõi th√¨ h·ªá th·ªëng s·∫Ω t·ª± lo vi·ªác k·∫øt n·ªëi m√† kh√¥ng c·∫ßn ch√∫ng ta ph·∫£i thao t√°c g√¨ th√™m. T∆∞∆°ng t·ª± khi 1 Node b·ªã xo√° th√¨ h·ªá th·ªëng ngay l·∫≠p t·ª©c t·ª± c√¢n b·∫±ng l·∫°i.
   - **3Ô∏è‚É£ Th·ªùi gian t√¨m ki·∫øm gi·∫£müìâ n·∫øu s·ªë Node tƒÉngüìà**: n√≥i cho d·ªÖ hi·ªÉu th√¨ data s·∫Ω chia ƒë·ªÅu cho c√°c Node, do ƒë√≥ khi t√¨m ki·∫øm t·∫•t c·∫£ c√°c Node (ch·ª©a d·ªØ li·ªáu li√™n quan) s·∫Ω tham gia v√¨ th·∫ø gi·∫£m ƒë∆∞·ª£c th·ªùi gian t√¨m ki·∫øm h∆°n n·∫øu c√≥ nhi·ªÅu node so v·ªõi d·ªìn l·∫°i 1 n∆°i nh∆∞ ·ªü database. T·∫•t nhi√™n ph·∫£i ƒë√°nh ƒë·ªïi vi·ªác nhi·ªÅu Node th√¨ s·∫Ω t·ªën nhi·ªÅu t√†i nguy√™n.
   - **4Ô∏è‚É£ T√≠nh ch·∫•t High Availability** c≈©ng l√† th·∫ø m·∫°nh c·ªßa Elasticsearch v·ªõi c√°c Replica node. Khi c√≥ 1 node ch·∫øt, ngay l·∫≠p t·ª©c Cluster s·∫Ω t√°i c·∫•u tr√∫c c√°c Shard l·∫°i ƒë·ªÉ ƒë·∫£m b·∫£o to√†n v·∫πn d·ªØ li·ªáu v√† ƒë·ªÅ ph√≤ng tr∆∞·ªõc cho tr∆∞·ªùng h·ª£p Node ti·∫øp theo c√≥ v·∫•n ƒë·ªÅ. 
   - **5Ô∏è‚É£ Elasticsearch kh√¥ng ch·ªâ v·ªÅ t√¨m ki·∫øm m√† c√≤n h·ªó tr·ª£ th·ªëng k√™ v√† ph√¢n t√≠ch d·ªØ li·ªáu r·∫•t hi·ªáu qu·∫£**: ƒë·∫∑c bi·ªát khi k·∫øt h·ª£p v·ªõi Kibana ƒë·ªÉ th·ªëng k√™ d·ªØ li·ªáu. V√≠ d·ª• xem s·∫£n ph·∫©m n√†o ƒë∆∞·ª£c quan t√¢m nhi·ªÅu, d·ªØ li·ªáu thanh to√°n ho·∫∑c order c·ªßa user. Ch√∫ng ta s·∫Ω ƒëi chi ti·∫øt v·ªÅ n·ªôi dung n√†y ·ªü b√†i vi·∫øt sau.
    - **6Ô∏è‚É£ Elasticsearch s·ª≠ d·ª•ng Apache Lucene (AL) behind the scene**: AL h·ªó tr·ª£ FTS n√™n gi√∫p tr·∫£ v·ªÅ k·∫øt qu·∫£ nhanh, c√°c d·ªØ li·ªáu li√™n quan (relevant) t·ªõi t·ª´ kh√≥a. Ngo√†i FTS ra th√¨ AL c√≤n h·ªó tr·ª£ th√™m nhi·ªÅu c√¥ng ngh·ªá kh√°c n·ªØa, c√≥ c∆° h·ªôi ch√∫ng ta s·∫Ω t√¨m hi·ªÉu ·ªü b√†i vi·∫øt kh√°c.
   - **7Ô∏è‚É£ ƒê∆°n gi·∫£n h∆°n trong vi·ªác index data**: n·∫øu ƒëem so s√°nh v·ªõi NoSQL ch√∫ng ta c≈©ng th·∫•y ƒëi·ªÉm t∆∞∆°ng ƒë·ªìng l√† ƒë·ªÅu l∆∞u tr·ªØ d·ªØ li·ªáu d∆∞·ªõi d·∫°ng document, tuy nhi√™n **NoSQL b·∫Øt bu·ªôc ch√∫ng ta ph·∫£i suy nghƒ© v·ªÅ vi·ªác ch·ªçn c√°c field nh∆∞ th·∫ø n√†o ƒë·ªÉ index hi·ªáu qu·∫£ v√† ph·∫£i query ra sao ƒë·ªÉ t·∫≠n d·ª•ng ƒë∆∞·ª£c c√°c index ƒë√≥**. V·ªõi Elasticsearch th√¨ t·∫•t c·∫£ c√°c fields ƒë·ªÅu ƒë∆∞·ª£c index n√™n ch√∫ng ta c√≥ th·ªÉ b·ªè qua ƒë∆∞·ª£c nh·ªØng m·ªëi lo ng·∫°i ƒë√≥. 
   - ...C√≤n r·∫•t nhi·ªÅu l·ª£i √≠ch kh√°c m√† m√¨nh ch∆∞a t·∫≠n d·ª•ng ƒë∆∞·ª£c h·∫øt, b·∫°n n√†o bi·∫øt th√™m c√≥ th·ªÉ b·ªï sung ·ªü comment ƒë·ªÉ ch√∫ng ta c√πng hi·ªÉu h∆°n nh√© üòâ

> ‚ö†Ô∏è ƒê√∫ng nh∆∞ c√°c b·∫°n v·ª´a nghƒ© t·ªõi, vi·ªác Elasticsearch index t·∫•t c√°c c√°c field ch√∫ng ta cung c·∫•p c≈©ng c√≥ th·ªÉ coi l√† t√°c h·∫°i n·∫øu ch√∫ng ta kh√¥ng qu·∫£n l√Ω hi·ªáu qu·∫£ 

**·ªû b√†i vi·∫øt n√†y m√¨nh s·∫Ω t·∫≠p trung v√†o ki·∫øn tr√∫c v√† c√°ch Elasticsearch l∆∞u tr·ªØ c≈©ng nh∆∞ t√¨m ki·∫øm d·ªØ li·ªáu (behind the scene)** n√™n s·∫Ω b·ªè qua ph·∫ßn kh√°i ni·ªám v√† qu√° tr√¨nh h√¨nh th√†nh c·ªßa Elasticsearch ƒë·ªÉ tr√°nh l√†m m·∫•t th·ªùi gian c·ªßa m·ªçi ng∆∞·ªùi. B·∫°n n√†o c√≥ h·ª©ng th√∫ t√¨m hi·ªÉu th√¨ c√≥ th·ªÉ ƒë·ªçc b√†i vi·∫øt c·ªßa b·∫°n Thanh B√¨nh, m√¨nh th·∫•y r·∫•t hay v√† chi ti·∫øt üëçÔ∏è https://viblo.asia/p/elasticsearch-zero-to-hero-1-elasticsearch-la-gi-cai-dat-the-nao-GyZJZxgbVjm. B√™n c·∫°nh ƒë√≥ ch√∫ng ta c≈©ng s·∫Ω th·ª±c h√†nh v·ªçc v·∫°ch m·ªôt t√≠ ƒë·ªÉ xem c√°ch Elasticsearch t√¨m ki·∫øm d·ªØ li·ªáu t·ª´ng b∆∞·ªõc m·ªôt ƒë·ªÉ c√≥ th·ªÉ hi·ªÉu 1 c√°ch s√¢u s·∫Øc nh·∫•t c√≥ th·ªÉ. Ch√∫ng ta c√πng b·∫Øt ƒë·∫ßu n√†o üòé!

# Ki·∫øn tr√∫c Elasticsearch c√≥ g√¨?
H√¨nh b√™n d∆∞·ªõi l√† ki·∫øn tr√∫c t·ªïng th·ªÉ c·ªßa 1 Cluster m√† Elasticsearch qu·∫£n l√Ω:
![](https://images.viblo.asia/93c2f47c-ef6c-4fab-b7ec-cfb30ae5c28c.png)

ƒê·ªÉ d·ªÖ h√¨nh dung ch√∫ng ta s·∫Ω mapping n√≥ v·ªõi RDMBS v√† NoSQL th√¥ng qua table b√™n d∆∞·ªõi:


| Elasticsearch Concept üîé | RDBMS Equivalent  üóÑÔ∏è | NoSQL Equivalent üìñ
| -------- | --------- |  --------- | 
| Cluster     | Database instance     | Database cluster     |
| Index     | Table / Schema     | Collection     |
| Shard	| Table partition / shard |	Shard / Partition  |
| Document     | Row     |  Document     |
| Field     | Column     | Field     |

Ch√∫ng ta s·∫Ω c√πng l·∫ßn l∆∞·ª£t t√¨m hi·ªÉu c√°c th√†nh ph·∫ßn tr√™n:
## 1. Cluster
Cluster trong Elasticsearch l√† t·∫≠p h·ª£p c√°c Node c√≥ c√πng thu·ªôc t√≠nh `cluster.name`. Khi ch√∫ng ta kh·ªüi ch·∫°y 1 instance c·ªßa Elasticsearch th√¨ 1 Node s·∫Ω ƒë∆∞·ª£c t·∫°o ra, do ƒë√≥ tr√™n 1 m√°y ch√∫ng ta c√≥ th·ªÉ c√†i ƒë·∫∑t c√πng l√∫c nhi·ªÅu Node ƒë·ªÉ m√¥ ph·ªèng Cluster.
>  ‚ö†Ô∏è L∆∞u √Ω: ch·ªâ n√™n d√πng ƒë·ªÉ dev v√† test th√¥i ch·ª© kh√¥ng n√™n d√πng ·ªü m√¥i tr∆∞·ªùng Production v√¨ l·ª° m√°y ƒë√≥ c√≥ v·∫•n ƒë·ªÅ th√¨ c√°c Node s·∫Ω ch·∫øt h·∫øt d·∫´n ƒë·∫øn m·∫•t d·ªØ li·ªáu
  
C√°c Node b√™n trong Cluster s·∫Ω c√πng chia s·∫ª d·ªØ li·ªáu v√† kh·ªëi l∆∞·ª£ng c√¥ng vi·ªác. N·∫øu ch√∫ng ta ch·ªâ start m·ªôt instance c·ªßa Elasticsearch th√¨ Cluster s·∫Ω c√≥ c·∫•u tr√∫c nh∆∞ b√™n d∆∞·ªõi:

![image.png](https://images.viblo.asia/6d0ff37a-2910-40da-b196-be45173f9e9c.png)

Ngu·ªìn: elastic.co

Khi 1 Node ƒë∆∞·ª£c th√™m v√†o ho·∫∑c xo√° kh·ªèi Cluster th√¨ **Cluster t·ª± ƒë·ªông t√°i t·ªï ch·ª©c l·∫°i ƒë·ªÉ ph√¢n ph·ªëi ƒë·ªìng ƒë·ªÅu d·ªØ li·ªáu** tr√™n c√°c Node c√≥ s·∫µn b√™n trong n√≥. H√¨nh d∆∞·ªõi bi·ªÉu di·ªÖn s·ª≠ thay ƒë·ªïi khi ch√∫ng ta th√™m 1 Node v√†o Cluster:

![image.png](https://images.viblo.asia/3a9760b0-8157-4bd1-973e-27e1c3d29ef8.png)

Ngu·ªìn: elastic.co

Gi·∫£i th√≠ch: 
- P l√† Primary shards, h√¨nh 1 ch√∫ng ta c√≥ P0, P1, P2 t∆∞∆°ng ·ª©ng 3 Shards l∆∞u tr·ªØ d·ªØ li·ªáu. 
- R l√† Replica shards, h√¨nh 2 ch√∫ng ta c√≥ R0, R1, R2 t∆∞∆°ng ·ª©ng 3 Shards d·ªØ li·ªáu copy c·ªßa P0, P1, P2. Ch√∫ng ta s·∫Ω n√≥i r√µ h∆°n ·ªü ph·∫ßn Shards.

Ch·ªâ n√≥i l√Ω thuy·∫øt th√¥i th√¨ h∆°i ch√°n n√™n ch√∫ng ta s·∫Ω th·ª±c h√†nh song song v·ªõi l√Ω thuy·∫øt lu√¥n nh√©. M√¨nh s·∫Ω d√πng docker ƒë·ªÉ tri·ªÉn khai tr∆∞·ªõc cho tr∆∞·ªùng h·ª£p **Single Node**:
```yml:single-node/docker-compose.yaml
# Tr∆∞·ªùng h·ª£p single node 
services:
  es-single-node:
    container_name: es-single-node
    image: docker.elastic.co/elasticsearch/elasticsearch:${STACK_VERSION}
    environment:
      - xpack.security.enabled=false
      - "discovery.type=single-node"
    ports:
      - 9200:9200
    networks:
      - es-net
networks:
  es-net:
    driver: bridge
```

Sau khi run `docker compose up -d`, truy c·∫≠p http://localhost:9200 v√† th·∫•y nh∆∞ h√¨nh b√™n d∆∞·ªõi l√† xong, qu√° tr√¨nh setup Single Node ch·ªâ ƒë∆°n gi·∫£n nh∆∞ v·∫≠y th√¥i.
![](https://images.viblo.asia/afeb7430-a4fa-410d-9392-2e77e69061bc.png)

Tr∆∞·ªùng h·ª£p c√†i **Multiple Node** l√°t n·ªØa ch√∫ng ta s·∫Ω t√¨m hi·ªÉu nh√©.
## 2. Node
Nh∆∞ ƒë√£ n√≥i ·ªü tr√™n, khi ch√∫ng ta start m·ªôt instance c·ªßa Elasticsearch n√≥ s·∫Ω t·∫°o ra 1 Node. Khi m·ªôt Node m·ªõi ƒë∆∞·ª£c th√™m v√†o h·ªá th·ªëng, n·∫øu tr√™n c√πng m·ªôt m√°y/server Node ƒë√≥ s·∫Ω t·ª± join v√†o Cluster khi ch√∫ng ta c·∫•u h√¨nh `cluster.name` gi·ªëng nhau - **ƒë√¢y l√† kh·∫£ nƒÉng scale d·ªÖ d√†ng 2Ô∏è‚É£** m√† ban ƒë·∫ßu m√¨nh nh·∫Øc ƒë·∫øn.
> Tr∆∞·ªùng h·ª£p kh√°c m√°y/server th√¨ c·∫ßn config th√™m danh s√°ch unicast m√† Node c√≥ th·ªÉ k·∫øt n·ªëi. [C√°c b·∫°n c√≥ th·ªÉ tham kh·∫£o c√°ch l√†m c·ªßa b√°c dinhhoanglong91](https://gist.github.com/dinhhoanglong91/87151af04cd210b0a0d8)

Node c√≥ t·ªïng c·ªông 7 lo·∫°i b√™n d∆∞·ªõi, nh∆∞ng trong ph·∫°m vi b√†i vi·∫øt n√†y ch√∫ng ta ch·ªâ n√≥i v·ªÅ 3 lo·∫°i ƒë·∫ßu ti√™n:

| Lo·∫°i Node üí† | Vai tr√≤ ch√≠nh ü´° | Th∆∞·ªùng d√πng cho ‚úÖÔ∏è | Vi·∫øt t·∫Øt
| -------- | --------- |  --------- | --------- | 
|***Master***|	Qu·∫£n l√Ω tr·∫°ng th√°i cluster, ph√¢n b·ªï shard, v√† metadata c·ªßa index.|	Qu·∫£n l√Ω cluster| m |
|***Data***|	L∆∞u tr·ªØ d·ªØ li·ªáu, th·ª±c hi·ªán indexing, ph√¢n t√≠ch v√† t√¨m ki·∫øm.|	X·ª≠ l√Ω d·ªØ li·ªáu v√† truy v·∫•n.| d |
|***Coordinating***|	Ph√¢n ph·ªëi y√™u c·∫ßu t·ª´ client ƒë·∫øn c√°c Node th√≠ch h·ª£p v√† t·ªïng h·ª£p k·∫øt qu·∫£ t√¨m ki·∫øm.| 	X·ª≠ l√Ω ƒë·ªÉ t·ªïng h·ª£p k·∫øt qu·∫£ truy v·∫•n ho·∫∑c ƒë√≥ng vai tr√≤ nh∆∞ m·ªôt b·ªô c√¢n b·∫±ng t·∫£i.| c |
|Ingest|	Ti·ªÅn x·ª≠ l√Ω (preprocessor) t√†i li·ªáu tr∆∞·ªõc khi index.|	Bi·∫øn ƒë·ªïi v√† l√†m gi√†u d·ªØ li·ªáu (v√≠ d·ª•: ph√¢n t√≠ch log, l√†m d·ªØ li·ªáu ƒë·ªãa l√Ω).| i |
|Remote-Eligible|	H·ªó tr·ª£ giao ti·∫øp gi·ªØa c√°c cluster cho vi·ªác t√¨m ki·∫øm v√† sao ch√©p d·ªØ li·ªáu.|	T√¨m ki·∫øm v√† sao ch√©p d·ªØ li·ªáu gi·ªØa nhi·ªÅu cluster.| r |
|Machine Learning|	Ch·∫°y c√°c c√¥ng vi·ªác machine learning nh∆∞ ph√°t hi·ªán b·∫•t th∆∞·ªùng v√† d·ª± ƒëo√°n.|	Ph√¢n t√≠ch n√¢ng cao v√† ph√°t hi·ªán m·∫´u d·ªØ li·ªáu.| l |
|Transform|	X·ª≠ l√Ω bi·∫øn ƒë·ªïi d·ªØ li·ªáu v√† c√°c ph√©p t·ªïng h·ª£p (v√≠ d·ª•: chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu, t·∫°o rollup).|	T·∫°o c√°c ch·ªâ m·ª•c t·ªïng h·ª£p v√† c√°c b·∫£ng nh√¨n t·ªïng quan ph√¢n t√≠ch.| t |

M·ªói Node ƒë·ªÅu ƒë·ªôc l·∫≠p v·ªõi nhau v√† ƒë·ªÅu c√≥ th·ªÉ handle:
- **HTTP**: t·∫•t c·∫£ c√°c Node ƒë·ªÅu c√≥ th·ªÉ nh·∫≠n REST request t·ª´ client. Khi nh·∫≠n request t·ª´ client, Node ƒë√≥ tr·ªü th√†nh Coordinate Node.
- **Transport layer**: c√°c giao ti·∫øp gi·ªØa c√°c Node v·ªõi nhau. Do ƒë√≥ m·ªói Node trong Elasticsearch ƒë·ªÅu bi·∫øt v·ªÅ t·∫•t c·∫£ c√°c Node c√≤n l·∫°i n√™n c√≥ th·ªÉ d·ªÖ d√†ng forward client request ƒë·∫øn c√°c Node th√≠ch h·ª£p. Giao ti·∫øp n√†y d·ªÖ th·∫•y nh·∫•t khi Coordinate Node ƒëi·ªÅu ph·ªëi y√™u c·∫ßu t·ªõi c√°c Node kh√°c ƒë·ªÉ nh·∫≠n v·ªÅ k·∫øt qu·∫£.

V·ªõi ki·∫øn tr√∫c Single Node ·ªü tr√™n th√¨ Node ƒë√≥ c√≥ th·ªÉ l√† b·∫•t c·ª© lo·∫°i n√†o v√† th∆∞·ªùng kh√¥ng ƒë∆∞·ª£c khuy·∫øn kh√≠ch d√πng cho m√¥i tr∆∞·ªùng Production. Ch√∫ng ta s·∫Ω d·ª±ng lu√¥n ki·∫øn tr√∫c **Multiple Node tr√™n c√πng 1 m√°y** v√† cho ch·∫°y ·ªü port 9200 (nh·ªõ t·∫Øt Single Node v·ª´a ch·∫°y khi n·∫£y nh√©) ƒë·ªÉ ki·ªÉm ch·ª©ng c√°c n·ªôi dung tr√™n. File n√†y m√¨nh l·∫•y tr·ª±c ti·∫øp t·ª´ trang c·ªßa Elasticsearch, m·ªçi ng∆∞·ªùi c√≥ th·ªÉ t·∫£i v·ªÅ ·ªü [link n√†y](https://github.com/elastic/elasticsearch/blob/8.17/docs/reference/setup/install/docker/docker-compose.yml)

```yml:multi-node/docker-compose.yml
services:
  setup:
    image: docker.elastic.co/elasticsearch/elasticsearch:${STACK_VERSION}
    volumes:
      - certs:/usr/share/elasticsearch/config/certs
    user: "0"
    command: >
      bash -c '
        if [ x${ELASTIC_PASSWORD} == x ]; then
          echo "Set the ELASTIC_PASSWORD environment variable in the .env file";
          exit 1;
        elif [ x${KIBANA_PASSWORD} == x ]; then
          echo "Set the KIBANA_PASSWORD environment variable in the .env file";
          exit 1;
        fi;
        if [ ! -f config/certs/ca.zip ]; then
          echo "Creating CA";
          bin/elasticsearch-certutil ca --silent --pem -out config/certs/ca.zip;
          unzip config/certs/ca.zip -d config/certs;
        fi;
        if [ ! -f config/certs/certs.zip ]; then
          echo "Creating certs";
          echo -ne \
          "instances:\n"\
          "  - name: es01\n"\
          "    dns:\n"\
          "      - es01\n"\
          "      - localhost\n"\
          "    ip:\n"\
          "      - 127.0.0.1\n"\
          "  - name: es02\n"\
          "    dns:\n"\
          "      - es02\n"\
          "      - localhost\n"\
          "    ip:\n"\
          "      - 127.0.0.1\n"\
          "  - name: es03\n"\
          "    dns:\n"\
          "      - es03\n"\
          "      - localhost\n"\
          "    ip:\n"\
          "      - 127.0.0.1\n"\
          > config/certs/instances.yml;
          bin/elasticsearch-certutil cert --silent --pem -out config/certs/certs.zip --in config/certs/instances.yml --ca-cert config/certs/ca/ca.crt --ca-key config/certs/ca/ca.key;
          unzip config/certs/certs.zip -d config/certs;
        fi;
        echo "Setting file permissions"
        chown -R root:root config/certs;
        find . -type d -exec chmod 750 \{\} \;;
        find . -type f -exec chmod 640 \{\} \;;
        echo "Waiting for Elasticsearch availability";
        until curl -s --cacert config/certs/ca/ca.crt https://es01:9200 | grep -q "missing authentication credentials"; do sleep 30; done;
        echo "Setting kibana_system password";
        until curl -s -X POST --cacert config/certs/ca/ca.crt -u "elastic:${ELASTIC_PASSWORD}" -H "Content-Type: application/json" https://es01:9200/_security/user/kibana_system/_password -d "{\"password\":\"${KIBANA_PASSWORD}\"}" | grep -q "^{}"; do sleep 10; done;
        echo "All done!";
      '
    healthcheck:
      test: [ "CMD-SHELL", "[ -f config/certs/es01/es01.crt ]" ]
      interval: 1s
      timeout: 5s
      retries: 120

  es01:
    depends_on:
      setup:
        condition: service_healthy
    image: docker.elastic.co/elasticsearch/elasticsearch:${STACK_VERSION}
    volumes:
      - certs:/usr/share/elasticsearch/config/certs
      - esdata01:/usr/share/elasticsearch/data
      # - ./logs:- /whatever/host/path/you/like:/usr/share/elasticsearch/logs
    ports:
      - ${ES_PORT}:9200
    environment:
      - node.name=es01
      - cluster.name=${CLUSTER_NAME}
      - cluster.initial_master_nodes=es01,es02,es03
      - discovery.seed_hosts=es02,es03
      - ELASTIC_PASSWORD=${ELASTIC_PASSWORD}
      - bootstrap.memory_lock=true
      - xpack.security.enabled=true
      - xpack.security.http.ssl.enabled=true
      - xpack.security.http.ssl.key=certs/es01/es01.key
      - xpack.security.http.ssl.certificate=certs/es01/es01.crt
      - xpack.security.http.ssl.certificate_authorities=certs/ca/ca.crt
      - xpack.security.transport.ssl.enabled=true
      - xpack.security.transport.ssl.key=certs/es01/es01.key
      - xpack.security.transport.ssl.certificate=certs/es01/es01.crt
      - xpack.security.transport.ssl.certificate_authorities=certs/ca/ca.crt
      - xpack.security.transport.ssl.verification_mode=certificate
      - xpack.license.self_generated.type=${LICENSE}
      - xpack.ml.use_auto_machine_memory_percent=true
    mem_limit: ${MEM_LIMIT}
    ulimits:
      memlock:
        soft: -1
        hard: -1
    healthcheck:
      test: [ "CMD-SHELL", "curl -s --cacert config/certs/ca/ca.crt https://localhost:9200 | grep -q 'missing authentication credentials'" ]
      interval: 10s
      timeout: 10s
      retries: 120

  es02:
    depends_on:
      - es01
    image: docker.elastic.co/elasticsearch/elasticsearch:${STACK_VERSION}
    volumes:
      - certs:/usr/share/elasticsearch/config/certs
      - esdata02:/usr/share/elasticsearch/data
    environment:
      - node.name=es02
      - cluster.name=${CLUSTER_NAME}
      - cluster.initial_master_nodes=es01,es02,es03
      - discovery.seed_hosts=es01,es03
      - ELASTIC_PASSWORD=${ELASTIC_PASSWORD}
      - bootstrap.memory_lock=true
      - xpack.security.enabled=true
      - xpack.security.http.ssl.enabled=true
      - xpack.security.http.ssl.key=certs/es02/es02.key
      - xpack.security.http.ssl.certificate=certs/es02/es02.crt
      - xpack.security.http.ssl.certificate_authorities=certs/ca/ca.crt
      - xpack.security.transport.ssl.enabled=true
      - xpack.security.transport.ssl.key=certs/es02/es02.key
      - xpack.security.transport.ssl.certificate=certs/es02/es02.crt
      - xpack.security.transport.ssl.certificate_authorities=certs/ca/ca.crt
      - xpack.security.transport.ssl.verification_mode=certificate
      - xpack.license.self_generated.type=${LICENSE}
      - xpack.ml.use_auto_machine_memory_percent=true
    mem_limit: ${MEM_LIMIT}
    ulimits:
      memlock:
        soft: -1
        hard: -1
    healthcheck:
      test: [ "CMD-SHELL", "curl -s --cacert config/certs/ca/ca.crt https://localhost:9200 | grep -q 'missing authentication credentials'" ]
      interval: 10s
      timeout: 10s
      retries: 120

  es03:
    depends_on:
      - es02
    image: docker.elastic.co/elasticsearch/elasticsearch:${STACK_VERSION}
    volumes:
      - certs:/usr/share/elasticsearch/config/certs
      - esdata03:/usr/share/elasticsearch/data
    environment:
      - node.name=es03
      - cluster.name=${CLUSTER_NAME}
      - cluster.initial_master_nodes=es01,es02,es03
      - discovery.seed_hosts=es01,es02
      - ELASTIC_PASSWORD=${ELASTIC_PASSWORD}
      - bootstrap.memory_lock=true
      - xpack.security.enabled=true
      - xpack.security.http.ssl.enabled=true
      - xpack.security.http.ssl.key=certs/es03/es03.key
      - xpack.security.http.ssl.certificate=certs/es03/es03.crt
      - xpack.security.http.ssl.certificate_authorities=certs/ca/ca.crt
      - xpack.security.transport.ssl.enabled=true
      - xpack.security.transport.ssl.key=certs/es03/es03.key
      - xpack.security.transport.ssl.certificate=certs/es03/es03.crt
      - xpack.security.transport.ssl.certificate_authorities=certs/ca/ca.crt
      - xpack.security.transport.ssl.verification_mode=certificate
      - xpack.license.self_generated.type=${LICENSE}
      - xpack.ml.use_auto_machine_memory_percent=true
    mem_limit: ${MEM_LIMIT}
    ulimits:
      memlock:
        soft: -1
        hard: -1
    healthcheck:
      test: [ "CMD-SHELL", "curl -s --cacert config/certs/ca/ca.crt https://localhost:9200 | grep -q 'missing authentication credentials'" ]
      interval: 10s
      timeout: 10s
      retries: 120
  kibana:
    depends_on:
      es01:
        condition: service_healthy
      es02:
        condition: service_healthy
      es03:
        condition: service_healthy
    image: docker.elastic.co/kibana/kibana:${STACK_VERSION}
    volumes:
      - certs:/usr/share/kibana/config/certs
      - kibanadata:/usr/share/kibana/data
    ports:
      - ${KIBANA_PORT}:5601
    environment:
      - SERVERNAME=kibana
      - ELASTICSEARCH_HOSTS=https://es01:9200
      - ELASTICSEARCH_USERNAME=kibana_system
      - ELASTICSEARCH_PASSWORD=${KIBANA_PASSWORD}
      - ELASTICSEARCH_SSL_CERTIFICATEAUTHORITIES=config/certs/ca/ca.crt
    mem_limit: ${MEM_LIMIT}
    healthcheck:
      test: [ "CMD-SHELL", "curl -s -I http://localhost:5601 | grep -q 'HTTP/1.1 302 Found'" ]
      interval: 10s
      timeout: 10s
      retries: 120

volumes:
  certs:
    driver: local
  esdata01:
    driver: local
  esdata02:
    driver: local
  esdata03:
    driver: local
  kibanadata:
    driver: local
```
Ch√∫ng ta c·∫≠p nh·∫≠t l·∫°i 1 s·ªë th√¥ng tin trong file **.env**. Elasticsearch version **8.17.1** l√† phi√™n b·∫£n stable t·∫°i th·ªùi ƒëi·ªÉm hi·ªán t·∫°i c·ªßa b√†i vi·∫øt.
```shell:multi-node/.env
# Password for the 'elastic' user (at least 6 characters)
ELASTIC_PASSWORD=boilerplate-nestjs

# Password for the 'kibana_system' user (at least 6 characters)
KIBANA_PASSWORD=boilerplate-nestjs

# Version of Elastic products
STACK_VERSION=8.17.1

# Set the cluster name
CLUSTER_NAME=docker-multi-node-cluster

# Set to 'basic' or 'trial' to automatically start the 30-day trial
LICENSE=basic

# Port to expose Elasticsearch HTTP API to the host
ES_PORT=127.0.0.1:9200

# Increase or decrease based on the available host memory (in bytes)
MEM_LIMIT=2147483648
```

L∆∞u √Ω ·ªü tr√™n file **docker-compose.yml** m√¨nh c√≥ b·ªï sung th√™m service **Kibana** dashboard ƒë·ªÉ l√°t ch√∫ng ta thao t√°c tr·ª±c ti·∫øp tr√™n Dev Tool cho d·ªÖ.
> Kibana c√≤n nhi·ªÅu c√¥ng d·ª•ng kh√°c, ch√∫ng ta s·∫Ω t√¨m hi·ªÉu ·ªü b√†i vi·∫øt v·ªÅ ELK stack, c√°c b·∫°n nh·ªõ ƒë√≥n xem nh√©.

Sau khi `docker compose up -d`, s·∫Ω m·∫•t kho·∫£ng 3-5 ph√∫t ƒë·ªÉ h·ªá th·ªëng setup Cluster v√† c√°c Node b√™n trong. Khi xong th√¨ truy c·∫≠p tr·ª±c ti·∫øp v√†o Kibana v·ªõi port 5601 http://localhost:5601 ƒë·ªÉ ƒëƒÉng nh·∫≠p. Th√¥ng tin username l√† **elastic** c√≤n password l√† gi√° tr·ªã ch√∫ng ta set ·ªü `KIBANA_PASSWORD=boilerplate-nestjs` trong file **.env**.

![](https://images.viblo.asia/21f6c301-defb-452d-a635-241b7f0174bb.png)

Sau khi login m√¨nh s·∫Ω truy c·∫≠p v√†o Dev Tool nh∆∞ gif b√™n d∆∞·ªõi, ch·∫°y l·ªánh `GET _cluster/health` ƒë·ªÉ ki·ªÉm tra t√¨nh tr·∫°ng Cluster. `"status": green` v√† `"number_of_nodes": 3` bi·ªÉu th·ªã cho ch√∫ng ta th·∫•y ƒëang kh·ªüi ch·∫°y th√†nh c√¥ng 1 Cluster v·ªõi 3 Node.

![](https://images.viblo.asia/e4058e4d-57a9-4ac5-9384-2dabc155e1aa.gif)


> B·∫°n n√†o g·∫∑p c√°c l·ªói sau th√¨ c√≥ th·ªÉ tham kh·∫£o c√°ch fix c·ªßa m√¨nh nh√©:
> - Exit code 78: ch·∫°y l·ªánh sau `sudo sysctl -w vm.max_map_count=262144`
> - Exit code 137: n√¢ng `MEM_LIMIT` trong file **.env**, ban ƒë·∫ßu ƒë·ªÉ m·∫∑c ƒë·ªãnh n√™n s·∫Ω d·ªÖ g·∫∑p l·ªói n√†y, c√°c b·∫°n n√¢ng l√™n `MEM_LIMIT=2147483648` n·∫øu b·ªã nh√©
### 2.1 Master Node üßë‚Äç‚öñÔ∏è
Nh∆∞ ƒë√£ ƒë·ªÅ c·∫≠p ·ªü tr√™n m·ªói Cluster s·∫Ω c√≥ m·ªôt Node ƒë∆∞·ª£c ch·ªçn l√†m Master Node, ch·ªãu tr√°ch nhi·ªám th√™m/xo√° Node v√†o Cluster c≈©ng nh∆∞ t·∫°o/xo√° Index. ƒê·ªÉ ki·ªÉm tra Node n√†o ƒëang l√† master ch√∫ng ta c√≥ th·ªÉ xem b·∫±ng l·ªánh `GET _cat/nodes?v`. Th·ª≠ ch·∫°y l·ªánh ƒë√≥ tr√™n Dev Tool Kibana xem sao nh√©:

![](https://images.viblo.asia/44992bc3-cbb1-4ece-98de-f3455732c1b3.png)


C√≥ th·ªÉ th·∫•y service **es01** ƒëang l√† Node ch·ªãu tr√°ch nhi·ªám l√†m Master Node. C√°c b·∫°n nh√¨n th√™m v√†o c·ªôt **node.role** s·∫Ω th·∫•y c√°c gi√° tr·ªã **cdfhilmrstw**, ƒë√¢y l√† vi·∫øt t·∫Øt bao g·ªìm t·∫•t c·∫£ c√°c role do ban ƒë·∫ßu ch√∫ng ta kh√¥ng ch·ªâ ƒë·ªãnh role cho ch√∫ng.

> ‚ö†Ô∏è ƒê·ªëi v·ªõi c√°c h·ªá th·ªëng c√≥ l∆∞·ª£ng traffic l·ªõn, khi d√πng ·ªü m√¥i tr∆∞·ªùng Production ch√∫ng ta n√™n ch·ªâ ƒë·ªãnh ri√™ng 1 Node l√†m Master ƒë·ªÉ n√≥ kh√¥ng ph·∫£i tham gia v√†o qu√° tr√¨nh ƒë·ªçc/ghi d·ªØ li·ªáu (lo·∫°i b·ªè role **"d"**: Data Node) v√¨ c√≥ th·ªÉ g√¢y gi·∫£m hi·ªáu nƒÉng.
### 2.2 Coordinate Node üëÆ
M·∫∑c ƒë·ªãnh n·∫øu ch√∫ng ta kh√¥ng config tr∆∞·ªõc th√¨ b·∫•t c·ª© Node n√†o khi nh·∫≠n ƒë∆∞·ª£c request th√¨ ngay l·∫≠p t·ª©c tr·ªü th√†nh Coordinate Node, ch·ªãu tr√°ch nhi·ªám ph√¢n b·ªï y√™u c·∫ßu ƒë·∫øn c√°c Node c·ª• th·ªÉ. 
L√°t n·ªØa khi t√¨m hi·ªÉu xong kh√°i ni·ªám v·ªÅ Shard ch√∫ng ta s·∫Ω n√≥i r√µ h∆°n v·ªÅ lo·∫°i Node n√†y.

> ·ªû tr√™n ch√∫ng ta d√πng Kibana v√† c√≥ khai b√°o `ELASTICSEARCH_HOSTS=https://es01:9200` n√™n request s·∫Ω tr·ª±c ti·∫øp g·ªçi ƒë·∫øn Node **es01** v√† c√≥ th·ªÉ coi n√≥ lu√¥n l√† Coordinate Node trong tr∆∞·ªùng h·ª£p n√†y.
## 3. Index
Index t∆∞∆°ng t·ª± nh∆∞ Database ·ªü RDBMS, **n·∫øu Database c√≥ Table/Schema ƒë·ªÉ l∆∞u tr·ªØ d·ªØ li·ªáu th√¨ Index c√≥ c√°c Shard**. Index ƒë∆°n gi·∫£n l√† m·ªôt **Logical Namespace** tr·ªè t·ªõi m·ªôt ho·∫∑c nhi·ªÅu **Physical Shards** (nghe h√†n l√¢m qu√° üòÖ). Gi·∫£i th√≠ch ƒë∆°n gi·∫£n h∆°n th√¨ **·ªü RDBMS ch√∫ng ta g·ªçi tr·ª±c ti·∫øp ƒë·∫øn Table** nh∆∞ng **·ªü Elasticsearch th√¨ ch√∫ng ta l·∫°i kh√¥ng g·ªçi tr·ª±c ti·∫øp ƒë·∫øn Shard m√† s·∫Ω th√¥ng qua Index**. 

Ch√∫ng ta th·ª≠ t·∫°o 1 Index ƒë·ªÉ ki·ªÉm ch√∫ng lu√¥n nh√©, qua Kibana v√† d√πng l·ªánh `PUT /demo-index`

![](https://images.viblo.asia/b00754af-b2a0-4080-a17a-cf4ac9bc4144.png)

Sau ƒë√≥ ki·ªÉm tra v·ªõi l·ªánh `GET /_cat/shards/demo-index?v`, nh√¨n v√†o k·∫øt qu·∫£ ch√∫ng ta th·∫•y ƒë∆∞·ª£c c√≥ 1 Primary Shard ƒë∆∞·ª£c t·∫°o ra ·ªü Node **es01** v√† 1 Replica Shard ·ªü Node **es02**. 

![](https://images.viblo.asia/b857deed-e983-4b1f-bb3f-e8ca663a94a6.png)

·ªû th·ªùi ƒëi·ªÉm version 8.17.1 khi ch√∫ng ta t·∫°o Index n·∫øu kh√¥ng ch·ªâ ƒë·ªãnh s·ªë l∆∞·ª£ng th√¨ Elasticsearch m·∫∑c ƒë·ªãnh s·∫Ω d√πng gi√° tr·ªã l√† 1 cho Primary Shard v√† Replica Shard (*t·ª´ version 7.0.0 tr·ªü v·ªÅ tr∆∞·ªõc th√¨ m·∫∑c ƒë·ªãnh l√† 5 Primary Shard*). Ch√∫ng ta ho√†n to√†n c√≥ th·ªÉ control s·ªë l∆∞·ª£ng b·∫±ng c√°ch b·ªï sung c√°c params l√∫c t·∫°o Index, do ch∆∞a t√¨m hi·ªÉu v·ªÅ Shard n√™n t·∫°m th·ªùi ch√∫ng ta xo√° Index v·ª´a t·∫°o v·ªõi l·ªánh `DELETE /demo-index` ƒë·ªÉ ƒë·∫øn ph·∫ßn k·∫ø ti·∫øp t·∫°o l·∫°i v√† n√≥i s√¢u h∆°n nh√©.

ƒê·∫øn ƒë√¢y m·∫∑c d√π ƒë√£ ƒë·∫°t ƒë∆∞·ª£c m·ª•c ti√™u High Availability üü¢ nh∆∞ng l·∫°i kh√¥ng mang l·∫°i kh√¥ng t·∫≠n d·ª•ng ƒë∆∞·ª£c kh·∫£ nƒÉng tƒÉng t·ªëc ƒë·ªô ƒë·ªçc d·ªØ li·ªáu khi c√≥ nhi·ªÅu Node c·ªßa Cluster üî¥. Hi·ªán t·∫°i th√¨ m·ªçi data ƒë·ªÅu ch·ªâ l∆∞u v√†o 1 Shards ·ªü **es01** v√† replicate sang **es02**.


## 4. Shards
> "M·ªói node s·∫Ω g·ªìm nhi·ªÅu shard l√† c√°c ƒë·ªëi t∆∞·ª£ng c·ªßa Lucene. Shard ho·∫°t ƒë·ªông ·ªü m·ª©c th·∫•p nh·∫•t, ƒë√≥ng vai tr√≤ l∆∞u tr·ªØ d·ªØ li·ªáu. Ch√∫ng ta g·∫ßn nh∆∞ kh√¥ng bao gi·ªù l√†m vi·ªác tr·ª±c ti·∫øp v·ªõi shard, Elasticsearch qu·∫£n l√Ω to√†n b·ªô giao ti·∫øp v·ªõi shard, t·ª± ƒë·ªông thay ƒë·ªïi khi c·∫ßn thi·∫øt." - dinhhoanglong91

**Khi Cluster c·ªßa ch√∫ng ta m·ªü r·ªông ho·∫∑c thu h·∫πp (tƒÉng/gi·∫£m s·ªë l∆∞·ª£ng c√°c Node), Elasticsearch s·∫Ω t·ª± ƒë·ªông migrate c√°c Shard gi·ªØa c√°c Nodes ƒë·ªÉ Cluster gi·ªØ ƒë∆∞·ª£c tr·∫°ng th√°i c√¢n b·∫±ng.**

V√≠ d·ª• minh ho·∫°: ch√∫ng ta c√≥ 3 Node, v√† t·∫°o 1 Index v·ªõi c·∫•u h√¨nh 3 Primary Shard v√† m·ªói Primary Shard c√≥ 2 Replica th√¨ Elasticsearch s·∫Ω chia m·ªói Node ch·ª©a 3 Shard bao g·ªìm 1 Primary v√† 2 Replica. Khi ch√∫ng ta ti·∫øn h√†nh xo√° 1 Node, Elasticsearch s·∫Ω t·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh l·∫°i ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh to√†n v·∫πn d·ªØ li·ªáu trong tr∆∞·ªùng h·ª£p 1 trong 2 Node c√≤n l·∫°i b·ªã l·ªói.  

Ch√∫ng ta c√πng thao th√°c th·ª≠ xem sao nh√©, ƒë·∫ßu ti√™n l√† t·∫°o Index:
```yml
PUT /demo-index
{
  "settings": {
    "number_of_shards": 3, // Index n√†y c√≥ 3 Primary Shard
    "number_of_replicas": 2 // M·ªói Primary Shard c√≥ 2 Replica Shard
  }
}
```

Ti·∫øn h√†nh ki·ªÉm tra l·∫°i k·∫øt qu·∫£ sau khi t·∫°o:
![](https://images.viblo.asia/e33047eb-afaa-41d2-b7fa-a41152dc764d.png)

C√≥ th·ªÉ th·∫•y ƒë∆∞·ª£c 3 Primary Shard ƒë√£ ƒë∆∞·ª£c t·∫°o ra v√† ƒë∆∞·ª£c ph√¢n b·ªë ƒë·ªìng ƒë·ªÅu ·ªü c·∫£ 3 Node. B√™n c·∫°nh ƒë√≥ t∆∞∆°ng ·ª©ng v·ªõi m·ªói Primary s·∫Ω c√≥ 2 Replica Shard v√† ch√∫ng c≈©ng ƒë∆∞·ª£c tr·∫£i ƒë·ªÅu tr√™n c√°c Node. 

Ch√∫ng ta th·ª≠ t·∫Øt Node **es02** xem sao nh√©, `"number_of_nodes": 2` bi·ªÉu th·ªã ch·ªâ c√≤n 2 Node trong Cluster. B√™n c·∫°nh ƒë√≥ `"status": "yello"` c≈©ng l√† v·∫•n ƒë·ªÅ ch√∫ng ta c·∫ßn l∆∞u t√¢m, n√≥ bi·ªÉu th·ªã d·ªØ li·ªáu c√≥ kh·∫£ nƒÉng b·ªã m·∫•t n·∫øu c√°c Node c√≤n l·∫°i hi·ªán t·∫°i x·∫£y ra v·∫•n ƒë·ªÅ.
![](https://images.viblo.asia/7d1f4294-9fed-4cd7-8987-ad743a57336b.png)

Khi nh√¨n v√†o logs c·ªßa Master Node **es01** c√°c b·∫°n s·∫Ω th·∫•y 1 th√¥ng b√°o status c·ªßa Cluster thay ƒë·ªïi v√† 1 th√¥ng b√°o c√≥ `node-left` (2 ch·ªó m√¨nh highlight)

![](https://images.viblo.asia/e59b76a1-06b5-47e9-98b2-f9e2089a77fb.png)

Ngo√†i ra khi k√©o xu·ªëng 1 t√≠ s·∫Ω th·∫•y th√™m th√¥ng b√°o ti·∫øn h√†nh ph√¢n b·ªï l·∫°i Shard sau 59.7 gi√¢y:

![](https://images.viblo.asia/766e010b-de64-4ae2-9714-3e81194f52da.png)

> üí° L√Ω do kh√¥ng ph√¢n b·ªï l·∫°i ngay l·∫≠p t·ª©c m√† ph·∫£i delay 1 th·ªùi gian ƒë·ªÉ tr√°nh tr∆∞·ªùng h·ª£p Node b·ªã r·ªõt m·∫°ng, b·ªüi v√¨ kh·ªëi l∆∞·ª£ng c√¥ng vi·ªác cho qu√° tr√¨nh ph√¢n b·ªï l·∫°i Shard s·∫Ω t·ªâ l·ªá thu·∫≠n v·ªõi l∆∞·ª£ng d·ªØ li·ªáu. Do ƒë√≥ n·∫øu ch·ªâ v√¨ 1 Node r·ªõt m·∫°ng kho·∫£ng 10 - 15 gi√¢y m√† ph·∫£i ph√¢n b·ªï l·∫°i Shard th√¨ r·∫•t l√£ng ph√≠ t√†i nguy√™n ü§ï. 

Sau khi ch·ªù th·ªùi gian tr√™n tr√¥i qua ch√∫ng ta v√†o xem l·∫°i th√¨ th·∫•y Primary Shard ·ªü Node **es02** ƒë√£ ƒë∆∞·ª£c ph√¢n b·ªë sang **es01**, c√°c Replica Shard c≈©ng ph√¢n b·ªë l·∫°i ƒë·ªÉ ƒë·∫£m b·∫£o d·ªØ li·ªáu v√† h·ªá th·ªëng ho·∫°t ƒë·ªông ·ªïn ƒë·ªãnh, n·∫øu kh√¥ng ƒë·ªß v·ªã tr√≠ th√¨ c√°c Replica Shard s·∫Ω ·ªü tr·∫°ng th√°i **UNASSIGNED**. 


![](https://images.viblo.asia/ae5fefbb-1e30-4c67-b301-0743c1f646d6.png)


> ‚ùìÔ∏èC√°c b·∫°n c√≥ th·∫Øc m·∫Øc t·∫°i sao 3 Replica Shard kia ·ªü tr·∫°ng th√°i **UNASSIGNED** kh√¥ng ‚ÅâÔ∏è C√¢u tr·∫£ l·ªùi l√† **Elasticsearch kh√¥ng cho ph√©p Primary Shard v√† Replica Shard c√πng n·∫±m tr√™n 1 Node üí°**. 
> 
> ‚ùìÔ∏è‚ùìÔ∏èC√≥ th·ªÉ c√°c b·∫°n s·∫Ω nghƒ© gi·ªëng m√¨nh l√† t·∫°i sao l·∫°i kh√¥ng ƒë∆∞·ª£c, "trong tr∆∞·ªùng h·ª£p t√¥i ƒë·ªìng √Ω v·ªõi r·ªßi ro khi thi·∫øt l·∫≠p c√πng Node c√≥ th·ªÉ g√¢y m·∫•t d·ªØ li·ªáu nh∆∞ng ƒë·ªïi l·∫°i t√¥i mu·ªën t·∫≠n d·ª•ng kh·∫£ nƒÉng tƒÉng throughput c·ªßa Replica Shard th√¨ sao üòêÔ∏è". 
> 
> => C√¢u tr·∫£ l·ªùi theo m√¨nh t√¨m hi·ªÉu th√¨ Elasticsearch c√≥ th·ªÉ x·ª≠ l√Ω concurrent n√™n c√°c query c√≥ th·ªÉ ƒë∆∞·ª£c x·ª≠ l√Ω ƒë·ªìng th·ªùi b·ªüi ch√≠nh Primary Shard d·ª±a v√†o multiple cores, do ƒë√≥ vi·ªác ƒë·∫∑t Replica Shard chung v·ªõi Primary Shard kh√¥ng mang l·∫°i √Ω nghƒ©a g√¨ ngo√†i vi·ªác ti√™u t·ªën th√™m t√†i nguy√™n üòÇ.
> 
Start l·∫°i Node **es02** xem th·ª≠ xem sao nh√© m·ªçi ng∆∞·ªùi üòÅ:

![](https://images.viblo.asia/951e7ee0-d841-42fd-8eed-86c99dcc1b61.png)

![](https://images.viblo.asia/d2c23def-13f9-431b-ac90-a1028cf295ea.png)

Sau khi kh·ªüi ƒë·ªông l·∫°i xong th√¨ ·ªü Master Node s·∫Ω c√≥ log `node-join`, kh√°c v·ªõi khi Node m·∫•t k·∫øt n·ªëi, khi c√≥ Node join v√†o th√¨ ngay l·∫≠p t·ª©c ƒë∆∞·ª£c ph√¢n b·ªï l·∫°i c√°c Shard, c√≥ th·ªÉ th·∫•y ƒë∆∞·ª£c kh·∫£ nƒÉng High Availability c·ªßa Elasticsearch r·∫•t m·∫°nh m·∫Ω ü¶æ.

> Khi data ƒë∆∞·ª£c index th√¨ s·∫Ω lu√¥n ƒëi v√†o Primary shard, sau ƒë√≥ ƒë∆∞·ª£c copy song song v√†o c√°c Replica Shard li√™n k·∫øt v·ªõi n√≥.
### 4.1 Primary Shard üë§
·ªû tr√™n ch√∫ng ta ƒë√£ bi·∫øt document ƒë∆∞·ª£c l∆∞u v√†o Primary Shard, nh∆∞ng trong m√¥i tr∆∞·ªùng ph√¢n t√°n c√≥ r·∫•t nhi·ªÅu Shard, v·∫≠y **l√†m sao ƒë·ªÉ bi·∫øt ƒë∆∞·ª£c document s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o shard n√†o üò≤‚ùìÔ∏è** 

C√¢u tr·∫£ l·ªùi t∆∞∆°ng t·ª± nh∆∞ sharding ·ªü c√°c database ch√∫ng ta c≈©ng s·∫Ω c√≥ c√¥ng th·ª©c, Elasticsearch khi routing document t·ªõi c√°c shards s·ª≠ d·ª•ng c√¥ng th·ª©c sau:

`shard = hash(routing) % number_of_primary_shards`

Gi·∫£i th√≠ch:
- `routing` c√≥ th·ªÉ l√† m·ªôt string b·∫•t k·ª≥,  m·∫∑c ƒë·ªãnh Elasticsearch s·∫Ω d√πng `_id` c·ªßa document
- `number_of_primary_shards` l√† s·ªë l∆∞·ª£ng Primary Shard, c√≥ ph·∫°m vi t·ª´ 0 ƒë·∫øn s·ªë l∆∞·ª£ng shards - 1. 

Do √°p d·ª•ng c√¥ng th·ª©c tr√™n n√™n khi ƒë·ªçc t√†i li·ªáu c·ªßa Elasticsearch ch√∫ng ta m·ªõi th·∫•y c√≥ quy t·∫Øc l√†:
>**‚ö†Ô∏è Ch·ªâ c√≥ th·ªÉ kh·ªüi t·∫°o s·ªë l∆∞·ª£ng Primary shard m·ªôt l·∫ßn duy nh·∫•t trong l√∫c t·∫°o Index. ‚ö†Ô∏è** 
>
>V√¨ n·∫øu s·ªë l∆∞·ª£ng Primary Shard thay ƒë·ªïi th√¨ c√°c routing value ch√∫ng ta d√πng ƒë·ªÉ ƒë·∫©y document v√†o c√°c Primary Shard tr∆∞·ªõc ƒë√≥ kh√¥ng c√≤n ƒë√∫ng n·ªØa, d·∫´n ƒë·∫øn c√°c document ƒë√≥ s·∫Ω kh√¥ng th·ªÉ t√¨m th·∫•y ch√≠nh x√°c ƒë∆∞·ª£c.

D√†nh cho tr∆∞·ªùng h·ª£p c√°c b·∫°n c√≥ suy nghƒ© l√† n·∫øu set c·ª©ng nh∆∞ v·∫≠y s·∫Ω kh√≥ ƒë·ªÉ scale l√™n th√¨ Elasticsearch b·∫£o r·∫±ng ch√∫ng ta ƒë·ª´ng lo l·∫Øng, h·ªç c√≥ nhi·ªÅu c√°ch ƒë·ªÉ scale l√™n ·ªü link n√†y: [Designing for Scale](https://www.elastic.co/guide/en/elasticsearch/guide/current/scale.html).
>C√°ch ƒë∆°n gi·∫£n nh·∫•t l√† t·∫°o Index m·ªõi v·ªõi s·ªë l∆∞·ª£ng Primary Shard mong mu·ªën, sau ƒë√≥ chuy·ªÉn document t·ª´ Index c≈© sang b·∫±ng API `_reindex`. C√≥ m·ªôt c√°ch kh√°c l√† d√πng Split ho·∫∑c Shrink API ƒë·ªÉ ƒëi·ªÅu ch·ªânh s·ªë l∆∞·ª£ng Shard, nh∆∞ng b·∫£n ch·∫•t c≈©ng l√† reindex, ch·∫≥ng qua Elasticsearch s·∫Ω x·ª≠ l√Ω gi√πm ch√∫ng ta th√¥i.

### 4.2 Replica Shard üë•
Ch√∫ng ta ƒë·ªÅu bi·∫øt data ƒë∆∞·ª£c l∆∞u tr·ªØ to√†n b·ªô tr√™n c√°c Primary Shard, ƒëi·ªÅu n√†y s·∫Ω d·∫´n ƒë·∫øn m·ªôt v·∫•n ƒë·ªÅ l√† khi Node ch·ª©a Shard ƒë√≥ b·ªã l·ªói th√¨ c√≥ th·ªÉ g√¢y ra t√¨nh tr·∫°ng m·∫•t d·ªØ li·ªáu. 

Replica Shard ra ƒë·ªùi ƒë·ªÉ gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ tr√™n, n√≥ l√† b·∫£n sao d·ªØ li·ªáu c·ªßa Primary Shard , Elasticsearch s·∫Ω l∆∞u tr·ªØ ch√∫ng ·ªü c√°c Node kh√°c so v·ªõi Primary Shard. Do ƒë√≥ khi Primary Shard c√≥ v·∫•n ƒë·ªÅ th√¨ ngay l·∫≠p t·ª©c c√°c Replica Shard s·∫Ω ch·ªçn ra m·ªôt ·ª©ng c·ª≠ vi√™n m·ªõi thay th·∫ø cho Primary shards v·ª´a b·ªã l·ªói (qu√° tr√¨nh n√†y di·ªÖn ra trong th·ªùi gian r·∫•t ng·∫Øn) nh·∫±m ƒë·∫£m b·∫£o d·ªØ li·ªáu lu√¥n ƒë∆∞·ª£c b·∫£o to√†n.

Ngo√†i ra Replica Shard c≈©ng c√≥ m·ªôt c√¥ng d·ª•ng tuy·ªát v·ªùi kh√°c l√† gi√∫p tƒÉng thoughput b·∫±ng vi·ªác x·ª≠ l√Ω c√°c Read Request nh∆∞ ƒë√£ n√≥i ·ªü tr√™n. Vi·ªác n√†y t∆∞∆°ng t·ª± nh∆∞ h·ªá th·ªëng Replica ·ªü c√°c c√¥ng ngh·ªá kh√°c.

·ªû c√°c ph·∫ßn tr√™n ch√∫ng ta ƒë√£ t√¨m hi·ªÉu s∆° qua v·ªÅ m·ªôt s·ªë kh√°i ni·ªám trong ki·∫øn tr√∫c c·ªßa Elasticsearch. Ph·∫ßn ti·∫øp theo ch√∫ng ta s·∫Ω c√πng b√†n v·ªÅ c√°ch Elasticsearch l∆∞u v√† query data, t·ª´ ƒë√≥ c√≥ ƒë∆∞·ª£c c√°i nh√¨n r√µ r√†ng nh·∫•t v·ªÅ c√°ch n√≥ ho·∫°t ƒë·ªông ƒë·ªÉ ch√∫ng ta c√≥ th·ªÉ t·∫≠n d·ª•ng ƒë∆∞·ª£c t·ªëi ƒëa s·ª©c m·∫°nh c·ªßa n√≥.
# How it works? ü§î
## 1. T√¨m hi·ªÉu c√°ch Elasticsearch l∆∞u data
Ch√∫ng ta s·∫Ω b·∫Øt ƒë·∫ßu ph·∫ßn n√†y b·∫±ng c√¢u h·ªèi: "**Nh·ªØng ho·∫°t ƒë·ªông g√¨ s·∫Ω x·∫£y ra khi Elasticsearch index document‚ùìÔ∏è**"

·ªû b√†i vi·∫øt tr∆∞·ªõc v·ªÅ [Text Index trong MongoDB](https://viblo.asia/p/setup-boilerplate-cho-du-an-nestjs-phan-12-full-text-search-voi-mongodb-bXP4WzjKV7G#_how-it-works--7) ch√∫ng ta ƒë√£ bi·∫øt v·ªÅ m·ªôt s·ªë kh√°i ni·ªám nh∆∞: **Without Diacritics, Process Filter Words, Steamming, Casing**. ƒê√≥ l√† c√°c giai ƒëo·∫°n ti·ªÅn x·ª≠ l√Ω (preprocess), ·ªü Elasticsearch c≈©ng t∆∞∆°ng t·ª± v√† ƒë∆∞·ª£c g·ªçi l√† **Analysis**, d√πng ƒë·ªÉ x·ª≠ l√Ω document th√†nh c√°c token tr∆∞·ªõc khi l∆∞u v√†o **Inverted Index**.

> **Inverted Index** l√† k·∫øt qu·∫£ c·ªßa b·∫£ng Index nh∆∞ h√¨nh b√™n d∆∞·ªõi m√† ·ªü b√†i vi·∫øt tr∆∞·ªõc m√† ch√∫ng ta ƒë√£ t√¨m hi·ªÉu:
> ![](https://images.viblo.asia/31753dfe-6292-408b-a520-e856e15487cb.png)

Elasticsearch khi ti·∫øn h√†nh x·ª≠ l√Ω document (g·ªçi l√† **Analyze** s·∫Ω chia l√†m 3 giai ƒëo·∫°n, m·ªói giai ƒëo·∫°n ƒë·ªÅu s·∫Ω nh·∫≠n v√†o input v√† cho ra output:
- **Character filter**
- **Tokenizer**
- **Token Filter**

Ch√∫ng ta s·∫Ω t√¨m hi·ªÉu chi ti·∫øt h∆°n b·∫±ng vi·ªác ƒëi v√†o t·ª´ng giai ƒëo·∫°n ƒë·ªÉ t√¨m hi·ªÉu v·ªÅ kh√°i ni·ªám v√† k·∫øt h·ª£p v·ªõi v√≠ d·ª• t√≠ch h·ª£p **Analyzer API** step by step nh√©.
### 1.1 Character Filter
Character Filter s·∫Ω th√™m, xo√° ho·∫∑c ch·ªânh s·ª≠a c√°c k√Ω t·ª±. V√≠ d·ª• lo·∫°i b·ªè tag HTML, chuy·ªÉn c√°c k√Ω t·ª± t·ª´ Hindu-Arabic (Ÿ†‚ÄéŸ°Ÿ¢Ÿ£Ÿ§Ÿ•Ÿ¶ŸßŸ®‚ÄéŸ©‚Äé) sang Arabic-Latin (0123456789). 

Gi·∫£ s·ª≠ ch√∫ng ta c√≥ c√¢u: `"<strong>I am a developer in developer in 2025! Ÿ£Ÿ§Ÿ•Ÿ¶Ÿß</strong>` v√† s·∫Ω th·ª≠ v·ªõi `html_strip`
```yml
POST _analyze
{
  "char_filter": ["html_strip"],
  "text":     "<strong>I am a developer in developer in 2025! Ÿ£Ÿ§Ÿ•Ÿ¶Ÿß</strong>"
}
```

![](https://images.viblo.asia/0d3d069e-4185-4d94-bbed-cc8fcc6b1d25.png)

T·ª´ k·∫øt qu·∫£ th·∫•y ƒë∆∞·ª£c r·∫±ng c√°c k√Ω t·ª± HTML ƒë√£ b·ªã xo√° ƒëi, tuy nhi√™n c√°c k√Ω t·ª± Hindu-Arabic th√¨ v·∫´n c√≤n t·ªìn ƒë·ªçng. Gi·ªù ch√∫ng ta s·∫Ω ti·∫øp t·ª•c √°p d·ª•ng th√™m filter `mapping`

```yml
POST _analyze
{
  "char_filter": ["html_strip", {
      "type": "mapping",
      "mappings": [
        "Ÿ£ => 3",
        "Ÿ§ => 4",
        "Ÿ• => 5",
        "Ÿ¶ => 6"
      ]
    }],
  "text":     "<strong>I am a developer in developer in 2025! Ÿ£Ÿ§Ÿ•Ÿ¶Ÿß</strong>"
}
```

![](https://images.viblo.asia/ec97f674-561c-41c5-9215-87e152a58515.png)

·ªû tr√™n m√¨nh c·ªë t√¨nh b·ªè mapping cho k√Ω t·ª± `Ÿß` n√™n c√°c b·∫°n th·∫•y ·ªü k·∫øt qu·∫£ v·∫´n c√≤n xu·∫•t hi·ªán k√Ω t·ª± n√†y. V·ªõi v√≠ d·ª• tr√™n ch√∫ng ta th·∫•y ƒë∆∞·ª£c Elasticsearch ƒë√£ x·ª≠ l√Ω gi·∫£m b·ªõt ƒë∆∞·ª£c ƒë·ªô ph·ª©c t·∫°p c·ªßa document v√† c≈©ng gi√∫p ch√∫ng ta c√≥ th·ªÉ ki·ªÉm so√°t ƒë∆∞·ª£c c√°c k√Ω t·ª± n·∫øu mu·ªën ‚úÖÔ∏è. Output t·ª´ giai ƒëo·∫°n n√†y s·∫Ω ƒë∆∞·ª£c chuy·ªÉn ƒë·∫øn l√†m Input cho b∆∞·ªõc Tokenizer ti·∫øp theo.
### 1.2 Tokenizer
Tokenizer m·∫∑c ƒë·ªãnh s·∫Ω nh·∫≠n v√†o 1 chu·ªói k√Ω t·ª± v√† c·∫Øt ch√∫ng th√†nh c√°c token khi g·∫∑p k√Ω t·ª± kho·∫£ng c√°ch (whitespace). V√≠ d·ª• `"I am a developer in developer in 2025!"` s·∫Ω ƒë∆∞·ª£c chuy·ªÉn th√†nh `[I, am, a, developer, in, 2025]`. C√πng m√¨nh th·ª≠ xem sao nh√©:

```yml
POST _analyze
{
  "tokenizer": "standard",
  "text":     "I am a developer in developer in 2025!"
}
```

![](https://images.viblo.asia/5225733e-59aa-4723-b9ca-4641d980f08d.png)



Tr√™n h√¨nh ngo·∫°i tr·ª´ chia ra th√†nh c√°c token, Tokenizer l∆∞u th√™m c√°c field kh√°c nh∆∞ `type`, `position`, `start_offset`, `end_offset` nh·∫±m m·ª•c ƒë√≠ch:
- Ghi nh·ªõ v·ªã tr√≠ c·ªßa t·ª´ng token trong chu·ªói ƒë·ªÉ ph·ª•c v·ª• cho tr∆∞·ªùng h·ª£p query **phrase** v√† **word proximity**. V√≠ d·ª• Elasticsearch s·∫Ω l∆∞u term c·ªßa ch√∫ng ta k√®m position nh∆∞ sau:

| Token | Position |
| -------- | -------- |
|I	|1|
|am	|2|
|a	|3|
|blogger	|4|
|in	|5|
|2025	|6|

- Ghi nh·ªõ k√Ω t·ª± ƒë·∫ßu ti√™n v√† cu·ªëi c√πng c·ªßa t·ª´ g·ªëc m√† term hi·ªán di·ªán, d√πng cho tr∆∞·ªùng h·ª£p **highlighting search snippets**. 

| Token | Start Offset | End Offset |
| -------- | -------- | -------- |
|I	|0| 1 | 
|am	|2| 4|
|a	|5| 6|
|blogger	|7| 14|
|in	|15| 17|
|2025	|18| 22|
V√≠ d·ª• ch√∫ng ta t√¨m t·ª´ "developer" th√¨  k·∫øt qu·∫£ tr·∫£ v·ªÅ nh∆∞ sau:
`"I am a <em>developer</em> in 2025!"`
```yml
# Th√™m(index) document v√†o demo-index
POST /demo-index/_doc
{
  "content": "I am a developer in developer in 2025!"
}

# Highlight search
GET /demo-index/_search
{
  "query": {
    "match": {
      "content": "developer"
    }
  },
  "highlight": {
    "fields": {
      "content": {}
    }
  }
}
```
![](https://images.viblo.asia/013df5cb-c3cd-40a0-b70c-77319af7557d.png)

C√°c b·∫°n th·∫•y ·ªü ph·∫ßn `hits > highlight > content` th√¨ t·ª´ kho√° t√¨m ki·∫øm **developer** c·ªßa ch√∫ng ta ƒë∆∞·ª£c highlight l√™n v·ªõi tag `<em>`
- L∆∞u tr·ªØ token type nh∆∞ `<ALPHANUM>, <HANGUL>, <NUM>, <EMOJI>,...`, ch·ªâ d√πng ƒë·∫øn v·ªõi c√°c tr∆∞·ªùng h·ª£p ch√∫ng ta mu·ªën t√¨m ki·∫øm theo 1 type n√†o ƒë√≥, khi ƒë√≥ Elasticsearch s·∫Ω ignore c√°c type c√≤n l·∫°i.

| Token | Token Type |
| -------- | -------- |
|I	| ALPHANUM|
|am	|ALPHANUM|
|a	|ALPHANUM|
|developer	|ALPHANUM|
|in	|ALPHANUM|
|2025	|NUM|

Document sau khi ƒë∆∞·ª£c Tokenizer c·∫Øt ra th√†nh c√°c term s·∫Ω ƒë∆∞·ª£c chuy·ªÉn ti·∫øp ƒë·∫øn b∆∞·ªõc cu·ªëi c√πng l√† Token Filter b√™n d∆∞·ªõi.
    
### 1.3 Token filter
Token filter t∆∞∆°ng t·ª± nh∆∞ **Process Filter Words**, n√≥ s·∫Ω nh·∫≠n k·∫øt qu·∫£ t·ª´ Tokenizer v√† th·ª±c hi·ªán c√°c filter:
- Ch·ªânh s·ª≠a chuy·ªÉn v·ªÅ k√Ω t·ª± vi·∫øt th∆∞·ªùng: `lowercase`
- Lo·∫°i b·ªè c√°c stopwords (nh∆∞ `a, an, the, is, at, which,...` trong ng√¥n ng·ªØ "en"): `stop`
- Chuy·ªÉn c√°c t·ª´ v·ªÅ nguy√™n m·∫´u: `stemmer`
- Th√™m v√†o c√°c token (v√≠ d·ª• t·ª´ ƒë·ªìng nghƒ©a) tu·ª≥ theo c√°ch ch√∫ng ta ch·ªçn **custom analyzer**: `synonym`
- ... v√† nhi·ªÅu filter kh√°c n·ªØa

Quay l·∫°i v·ªõi v√≠ d·ª• c·ªßa ch√∫ng ta `"I am a developer in developer in 2025!"` sau khi Tokenizer th√¨ ƒë·∫øn Token Filter tr·∫£i qua m·ªôt s·ªë filter s·∫Ω c√≤n nh∆∞ sau: `[I, am, develop, 2025]`
```yml
POST _analyze
{
  "tokenizer": "standard", # C·∫ßn th√™m b∆∞·ªõc n√†y ƒë·ªÉ Elasticsearch chuy·ªÉn document th√†nh Term
  "filter": ["lowercase", "stop", "stemmer"],
  "text":     "I am a developer in 2025!"
}
```
![](https://images.viblo.asia/b09df168-6c3d-437d-a4e2-6a38076d524a.png)

Trong tr∆∞·ªùng h·ª£p c√°c b·∫°n mu·ªën xem chi ti·∫øt h∆°n c√≥ th·ªÉ th√™m field `explan: true` v√†o nh∆∞ b√™n d∆∞·ªõi, khi ƒë√≥ ch√∫ng ta s·∫Ω th·∫•y khi tr·∫£i qua t·ª´ng filter th√¨ c√°c term s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω nh∆∞ th·∫ø n√†o:
```yml
POST _analyze
{
  "tokenizer": "standard",
  "explain": true, # <=== Th√™m v√†o ƒë√¢y
  "filter": ["lowercase", "stop", "stemmer"],
  "text":     "I am a developer in 2025!"
}
```

![](https://images.viblo.asia/9e4840a8-21ff-46d0-a11e-be811e815196.png)

Sau khi tr·∫£i qua giai ƒëo·∫°n Analyzer, k·∫øt qu·∫£ cu·ªëi c√πng s·∫Ω ƒë∆∞·ª£c l∆∞u tr·ªØ v√†o Inverted Index.

> üí°**Object c√≥ bao nhi√™u field s·∫Ω c√≥ t∆∞∆°ng ·ª©ng b·∫•y nhi√™u Inverted Index.**

T·ªïng k·∫øt l·∫°i n·∫øu ch√∫ng ta c√≥ 2 document v√† d√πng Analyzer nh∆∞ v√≠ d·ª• ·ªü tr√™n th√¨ s·∫Ω thu ƒë∆∞·ª£c Inverted Index nh∆∞ b·∫£ng ph√≠a d∆∞·ªõi:

```json:document-1
{
    "name": "John Doe",
    "description": "<i>I am a developer in 2025!</i>"
}
```

```json:document-2
{
    "name": "John Smith",
    "description": "<strong>I am the main actor of the program </strong>"
}
```

- Field `name`

| Terms | Documents | 
| -------- | -------- | 
| doe     | document-**1**     | 
| john | document-**1**, document-**2** |
| smith     |  document-**2**    | 

- Field `description`

| Terms | Documents | 
| -------- | -------- | 
| 2025     | document-**1**     | 
| actor | document-**2** |
| am     | document-**1**, document-**2**    | 
| develop     | document-**1**     | 
| i     | document-**1**,  document-**2**   | 
| main | document-**2** |
| program | document-**2** |

V·∫≠y l√† ch√∫ng ta ƒë√£ t√¨m hi·ªÉu xong c√°ch m√† Elasticsearch index document, ph·∫ßn ti·∫øp theo ch√∫ng ta s·∫Ω c√πng xem c√°ch Elasticsearch query data di·ªÖn ra trong h·ªá th·ªëng Cluster nh∆∞ th·∫ø n√†o.
## 2 T√¨m hi·ªÉu c√°ch Elasticsearch search d·ªØ li·ªáu gi·ªØa c√°c Node
ƒê·ªÉ th·ª±c hi·ªán vi·ªác t√¨m ki·∫øm Elasticsearch chia qu√° tr√¨nh ƒë√≥ ra l√†m 2 giai ƒëo·∫°n g·ªçi l√† `query` v√† `fetch`:
- **`query` phrase üîé: qu√° tr√¨nh t√¨m ki·∫øm document ·ªü c√°c Shard**
- **`fetch` phrase ‚è¨Ô∏è: qu√° tr√¨nh t·ªïng h·ª£p k·∫øt qu·∫£ t·ª´ c√°c Shard**

### 2.1 Query phrase
![image.png](https://images.viblo.asia/966f3751-b9a0-4eb3-9b22-69e5f0b89196.png)

Ngu·ªìn: elastic.co

**Khi request ƒë·∫øn m·ªôt Node b·∫•t k·ª≥, Node ƒë√≥ tr·ªü th√†nh Coordinating Node** (tr√™n h√¨nh l√† Node 3). Khi ƒë√≥, n√≥ **ch·ªãu tr√°ch nhi·ªám broadcast query ƒë·∫øn c√°c Shard c√≥ li√™n quan v√† thu th·∫≠p k·∫øt qu·∫£** t·ª´ c√°c Shard ƒë√≥ v√† tr·∫£ v·ªÅ cho client.

Khi query ƒë·∫øn Shard, n√≥ s·∫Ω t·∫°o ra 1 queue ƒë·ªÉ ch·ª©a k·∫øt qu·∫£ g·ªçi l√† **Priority queue**, vi·ªác t√¨m ki·∫øm s·∫Ω ƒë∆∞·ª£c th·ª±c hi·ªán local v√† ƒë·∫©y k·∫øt qu·∫£ v√†o Priority queue.
> Priority queue l√† m·ªôt danh s√°ch ƒë∆°n gi·∫£n ch·ª©a c√°c document t√¨m ki·∫øm ƒë∆∞·ª£c, k√≠ch th∆∞·ªõc c·ªßa n√≥ ph·ª• thu·ªôc v√†o c√°c tham s·ªë pagination `from` + `size`. 

![](https://images.viblo.asia/a7cbb394-892d-4b58-b363-97745052aa06.png)

Sau khi ho√†n th√†nh n√≥ s·∫Ω tr·∫£ v·ªÅ k·∫øt qu·∫£ cho Coordinating node **nh∆∞ng s·∫Ω ch·ªâ bao g·ªìm `id` v√† c√°c field c·∫ßn thi·∫øt** cho qu√° tr√¨nh sorting **nh∆∞ `_score`**. 

Coordinating node nh·∫≠n k·∫øt qu·∫£ t·ª´ c√°c Shard v√† t·ªïng h·ª£p v√†o Priority queue c·ªßa ri√™ng n√≥ v√† k·∫øt l√∫c `query` phrase.

![](https://images.viblo.asia/943fbd0c-b9a4-4728-bdc7-2a9e7fbdc45e.png)

### 2.2 Fetch phrase
![image.png](https://images.viblo.asia/a717a6bd-1cb9-4698-8167-c0f94c466ed8.png)

Ngu·ªìn: elastic.co

·ªû phrase n√†y Coordinating node ti·∫øp t·ª•c nhi·ªám v·ª• c·ªßa n√≥, x·ª≠ l√Ω k·∫øt qu·∫£ t·ª´ c√°c Shard g·ª≠i ƒë·∫øn. Vi·ªác x·ª≠ l√Ω ch·ªâ ƒë∆°n gi·∫£n lo·∫°i b·ªè c√°c k·∫øt qu·∫£ n·∫±m ngo·∫°i ph·∫°m vi pagination d·ª±a v√†o field `_score`. 

V√≠ d·ª• ch√∫ng ta c√≥ pagination nh∆∞ sau: `{ "from": 2, "size": 3 }`. Gi·∫£ s·ª≠ m·ªói s·ªë ƒë∆∞·ª£c ghi tr√™n √¥ l√† `_score` th√¨ Coordinating node s·∫Ω **lo·∫°i b·ªè 2 k·∫øt qu·∫£ ƒë·∫ßu v√† ch·ªçn ra 3 k·∫øt qu·∫£ ti·∫øp theo** c√≥ score cao h∆°n s·ªë c√≤n l·∫°i. 

![](https://images.viblo.asia/523944db-4dc0-480d-83e7-f3f0a3b79044.png)

Tuy nhi√™n ch√∫ng ta c·∫ßn l∆∞u √Ω 3 k·∫øt qu·∫£ n√†y ch·ªâ bao g·ªìm `id` v√† c√°c field d√πng ƒë·ªÉ search, kh√¥ng th·ªÉ tr·∫£ v·ªÅ cho client ƒë∆∞·ª£c. Coordinating node s·∫Ω ph·∫£i th·ª±c hi·ªán th√™m 1 b∆∞·ªõc n·ªØa l√† d√πng c√°c `id` n√†y g·ªçi ƒë·∫øn c√°c Shard tr∆∞·ªõc ƒë√≥ ƒë·ªÉ l·∫•y v·ªÅ data ƒë·∫ßy ƒë·ªß.

![](https://images.viblo.asia/7a4b69fb-a0a2-43a3-add4-2c714962e093.png)


> C√≥ th·ªÉ c√°c b·∫°n s·∫Ω th·∫•y qu√° tr√¨nh n√†y c√≥ v·∫ª d∆∞ th·ª´a, t·∫°i sao c√°c Shard kh√¥ng tr·∫£ v·ªÅ ƒë·∫ßy ƒë·ªß data sau khi t√¨m ki·∫øm ƒë·ªÉ Coordinating node ƒë·ª° ph·∫£i g·ªçi th√™m m·ªôt l·∫ßn. Tuy nhi√™n th·ª© ch√∫ng ta c·∫ßn c√¢n nh·∫Øc ·ªü ƒë√¢y l√† chi ph√≠ khi tr·∫£ v·ªÅ to√†n b·ªô d·ªØ li·ªáu c·ªßa k·∫øt qu·∫£ ch·ª© kh√¥ng ph·∫£i l√† s·ªë l·∫ßn g·ªçi l·∫•y k·∫øt qu·∫£. 
> V√≠ d·ª• m·ªói document l√† 10Kb, v√† ch√∫ng ta d√πng pagination l√† `{ "from": 3, "size": 10 }` v√† ch√∫ng ta c√≥ 3 Shard:
> - Tr∆∞·ªùng h·ª£p tr·∫£ v·ªÅ 1 l·∫ßn th√¨ m·ªói shards tr∆∞·ªùng h·ª£p c√≥ ƒë·ªß d·ªØ li·ªáu s·∫Ω tr·∫£ v·ªÅ 100 result * 10Kb = 1000Kb, v·ªã chi s·∫Ω ti√™u t·ªën kho·∫£ng 4000Kb. 
> - Tr∆∞·ªùng h·ª£p ch·ªâ tr·∫£ v·ªÅ `id` v√† `_score` gi·∫£ s·ª≠ kho·∫£ng 0.2Kb cho m·ªói document th√¨ m·ªói shards s·∫Ω t·ªën 100 * 0.2Kb = 20Kb cho l·∫ßn g·ªçi ƒë·∫ßu ti√™n, 4 Shard l√† 80Kb. L·∫ßn g·ªçi th·ª© 2 ch√∫ng ta l·∫•y ra 10 k·∫øt qu·∫£ d·ª±a theo `id` t·ª´ c√°c Shard s·∫Ω ti√™u t·ªën 10 * 10 = 100Kb. T·ªïng c·ªông 2 l·∫ßn g·ªçi ti√™u t·ªën 80 + 100 = 180Kb.
> 
> C√≥ th·ªÉ th·∫•y k·∫øt qu·∫£ ch√™nh l·ªách gi·ªØa 2 tr∆∞·ªùng h·ª£p l√† kh√° nhi·ªÅu, v√† khi pagination c√†ng cao th√¨ s·ª± ch√™nh l·ªách c√†ng l·ªõn. 

# K·∫øt lu·∫≠n üìù
V·∫≠y l√† ch√∫ng ta ƒë√£ ƒëi qua h·∫øt c√°c ph·∫ßn t·ª´ ki·∫øn tr√∫c, ch·ª©c nƒÉng c·ªßa t·ª´ng th√†nh ph·∫ßn trong Cluster ƒë·∫øn qu√° tr√¨nh Elasticsearch index document v·ªõi Analyzer v√† l∆∞u v√†o Inverted Index. Ch√∫ng ta c≈©ng bi·∫øt ƒë∆∞·ª£c ƒë·ªÉ vi·ªác search ƒë∆∞·ª£c t·ªëi ∆∞u Elasticsearch ƒë√£ tr·∫£i qua nh·ªØng Phrase n√†o. V·∫´n c√≤n nhi·ªÅu nh·ªØng kh√°i ni·ªám nh∆∞ Precision, Recall,...  m√† ch√∫ng ta ch∆∞a t√¨m hi·ªÉu qua, nh∆∞ng hi·ªán t·∫°i b√†i vi·∫øt ƒë√£ qu√° d√†i n√™n h·∫πn m·ªçi ng∆∞·ªùi ·ªü b√†i vi·∫øt ti·∫øp theo üòâ. B√†i vi·∫øt ti·∫øp theo ch√∫ng ta c≈©ng s·∫Ω th·ª±c h√†nh nhi·ªÅu h∆°n v√† √°p d·ª•ng v√†o source code NestJS v·ªÅ Flash Card project m√† tr∆∞·ªõc gi·ªù ch√∫ng ta l√†m ƒë·ªÉ h√¨nh dung trong th·ª±c t·∫ø Elasticsearch s·∫Ω ho·∫°t ƒë·ªông nh∆∞ th·∫ø n√†o nh√©ü§©.

C·∫£m ∆°n m·ªçi ng∆∞·ªùi ƒë√£ gi√†nh th·ªùi gian ƒë·ªçc b√†i vi·∫øt, ch√∫c m·ªçi ng∆∞·ªùi nƒÉm m·ªõi vui v·∫ª v√† g·∫∑t h√°i ƒë∆∞·ª£c nhi·ªÅu th√†nh c√¥ng üòäüéâ.
# T√†i li·ªáu tham kh·∫£o üîç
- Andersen, B. (2018) Understanding analysis in Elasticsearch (analyzers), Coding Explained. Available at: https://codingexplained.com/coding/elasticsearch/understanding-analysis-in-elasticsearch-analyzers (Accessed: 05 February 2025). 
- Character filters reference (no date) Elastic. Available at: https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-charfilters.html (Accessed: 05 February 2025). 
- Tokenizer reference (no date) Elastic. Available at: https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-tokenizers.html (Accessed: 05 February 2025). 
- tripy_ran (2015) Inverted index per field, Discuss the Elastic Stack. Available at: https://discuss.elastic.co/t/inverted-index-per-field/31468 (Accessed: 05 February 2025).  
- Mohan, A. (2018) What happens when a document is indexed in Elasticsearch?, Medium. Available at: https://medium.com/elasticsearch/what-happens-when-a-document-is-indexed-in-elasticsearch-16b7ae3415bc (Accessed: 05 February 2025). 
- Nathani, R. (2016) Anatomy of an elasticsearch cluster: Part III, Medium. Available at: https://blog.insightdatascience.com/anatomy-of-an-elasticsearch-cluster-part-iii-8bb6ac84488d (Accessed: 05 February 2025). 
- dinhhoanglong91 (2025) Elasticsearch: Distributed search, Viblo. Available at: https://viblo.asia/p/elasticsearch-distributed-search-ZnbRlr6lG2Xo#_shard-4 (Accessed: 05 February 2025). 
# Change log üìì
- February 06, 2025: Init document.